<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C&M Gesti√≥n de Pagos</title>
    
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <style>
        /* ESTILOS (Dark Theme) */
        body { font-family: 'Segoe UI', Roboto, sans-serif; background-color: #121212; color: #eee; margin: 0; padding-bottom: 150px; display: flex; flex-direction: column; align-items: center; }
        
        /* HEADER CON LOGO */
        .app-header { width: 100%; background: #1e1e1e; padding: 10px 20px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; box-sizing: border-box; position: sticky; top: 0; z-index: 100; }
        .logo-area { display: flex; align-items: center; gap: 10px; }
        .logo-img { height: 45px; border-radius: 8px; border: 1px solid #444; }
        .app-info { display:flex; flex-direction:column; }
        .app-name { font-weight: 800; font-size: 1rem; color: #fff; line-height:1.1; }
        .app-sub { font-size: 0.75rem; color: #BB86FC; }
        
        .user-badge { text-align: right; }
        .user-email { color: #ccc; font-size: 0.75rem; }
        .group-tag { background: #00e676; color: #000; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: bold; display: inline-block; margin-top: 2px; }

        /* PANTALLAS LOGIN / GRUPO */
        #authScreen, #groupScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #050505; z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .auth-box { background: #1e1e1e; padding: 30px; border-radius: 15px; border: 1px solid #333; width: 90%; max-width: 350px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .auth-btn { width: 100%; padding: 12px; margin-top: 10px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .auth-btn:hover { transform: translateY(-2px); }
        .btn-google { background: #fff; color: #333; display: flex; align-items: center; justify-content: center; gap: 10px; }
        
        /* GENERAL UI */
        .tabs { display: flex; width: 95%; max-width: 1400px; margin: 15px auto; background: #252525; border-radius: 12px; border: 1px solid #333; overflow: hidden; }
        .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; color: #888; font-weight: 600; }
        .tab.active { background: #BB86FC; color: #000; font-weight: 800; }
        .view { display: none; width: 95%; max-width: 1400px; margin: 0 auto; flex-direction: column; gap: 15px; }
        .view.active { display: flex; }

        .dashboard-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .dash-card { background: #1e1e1e; padding: 15px; border-radius: 12px; border: 1px solid #333; text-align: center; }
        .dash-val { font-size: 1.1rem; font-weight: bold; font-family: monospace; margin-top:5px; }
        .c-g { color: #00e676; } .c-r { color: #ff5252; } .c-p { color: #BB86FC; }

        /* TABLA */
        .grid-con { overflow-x: auto; background: #1e1e1e; border-radius: 8px; border: 1px solid #333; min-height: 300px; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 900px; }
        th { background: #252525; position: sticky; top: 0; padding: 10px; color: #aaa; border-bottom: 2px solid #444; z-index: 20; }
        td { border-bottom: 1px solid #333; border-right: 1px solid #333; height: 55px; vertical-align: middle; }
        .col-fix { position: sticky; left: 0; background: #1e1e1e; border-right: 2px solid #444 !important; z-index: 30; min-width: 160px; max-width: 160px; }
        
        /* FOOTER */
        .footer { position: fixed; bottom: 0; width: 100%; background: #1a1a1a; padding: 15px; border-top: 1px solid #333; text-align: center; z-index: 50; display:flex; flex-direction:column; gap:10px; align-items:center; }
        .cafe-row { display: flex; gap: 10px; justify-content: center; width: 100%; max-width: 400px; }
        
        /* UTILIDADES */
        .btn { padding: 10px; width: 100%; border-radius: 5px; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-p { background: #BB86FC; color: #000; }
        .btn-s { background: #333; color: #ccc; border: 1px solid #555; }
        input, select { width: 100%; padding: 12px; margin: 5px 0 15px 0; background: #151515; border: 1px solid #444; color: #fff; border-radius: 5px; box-sizing: border-box; }
        .fab { position: fixed; bottom: 120px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background: #BB86FC; color: #000; font-size: 2rem; border: none; cursor: pointer; display: flex; justify-content: center; align-items: center; z-index: 60; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; justify-content: center; align-items: center; }
        .modal-box { background: #252525; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; border: 1px solid #555; }

        .status-paid { background: rgba(0, 230, 118, 0.15); border-left: 3px solid #00e676; }
        .status-pend { background: rgba(255, 82, 82, 0.15); border-left: 3px solid #ff5252; }
    </style>
</head>
<body>

    <div id="authScreen">
        <div class="auth-box">
            <img src="logo.jpg" style="height:70px; border-radius:10px; margin-bottom:15px; border:1px solid #444;">
            <h2 style="color:#BB86FC; margin:0;">C&M Pagos</h2>
            <p style="color:#aaa; font-size:0.9rem;">Accede a tu panel de control</p>
            
            <input type="email" id="email" placeholder="Correo electr√≥nico">
            <input type="password" id="password" placeholder="Contrase√±a">
            <button class="auth-btn btn-p" onclick="loginEmail()">Iniciar Sesi√≥n</button>
            <button class="auth-btn btn-s" onclick="registerEmail()">Crear Cuenta</button>
            
            <div style="margin:20px 0; border-top:1px solid #333; padding-top:15px; color:#555; font-size:0.8rem;">O CONTINUA CON</div>
            <button class="auth-btn btn-google" onclick="loginGoogle()">
                <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" width="20"> Google
            </button>
            <p id="authMsg" style="color:#ff5252; margin-top:10px; font-size:0.9rem;"></p>
        </div>
    </div>

    <div id="groupScreen" style="display:none;">
        <div class="auth-box">
            <h2 style="color:#BB86FC;">Seleccionar Grupo</h2>
            <p style="color:#aaa;">Ingresa el nombre de tu grupo/familia</p>
            <input type="text" id="groupNameInput" placeholder="Ej: MATTEI_CASA" style="text-transform:uppercase; text-align:center; font-size:1.2rem; letter-spacing:1px;">
            
            <div id="pinArea" style="display:none; background:#2a2a2a; padding:15px; border-radius:8px; margin-bottom:15px; border:1px solid #444;">
                <p style="margin:0 0 5px 0; font-size:0.9rem; color:#ffb74d;">üîí Grupo Privado</p>
                <p style="margin:0 0 10px 0; font-size:0.8rem; color:#ccc;">Este grupo ya existe. Ingresa el PIN para unirte.</p>
                <input type="text" id="groupPinInput" placeholder="0000" style="text-align:center; letter-spacing:5px; font-size:1.5rem; width:100px; margin:0 auto;">
            </div>

            <button class="auth-btn btn-p" onclick="checkGroup()">ENTRAR</button>
            <button class="auth-btn btn-s" style="margin-top:20px;" onclick="logout()">Cerrar Sesi√≥n</button>
            <p id="groupMsg" style="color:#ff5252; margin-top:10px; font-size:0.9rem;"></p>
        </div>
    </div>

    <div class="app-header">
        <div class="logo-area">
            <img src="logo.jpg" class="logo-img" alt="Logo">
            <div class="app-info">
                <span class="app-name">C&M</span>
                <span class="app-sub">Gesti√≥n de Pagos</span>
            </div>
        </div>
        <div class="user-badge">
            <div class="user-email" id="dispUserEmail">...</div>
            <div class="group-tag" id="dispGroupName">...</div>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('planilla')">üìù Planilla</div>
        <div class="tab" onclick="switchTab('cuentas')">üí≥ Cuentas</div>
        <div class="tab" onclick="switchTab('config')">‚öôÔ∏è Config</div>
    </div>

    <div id="view-planilla" class="view active">
        <div class="dashboard-grid">
            <div class="dash-card"><div class="dash-val c-g" id="dTotal">$0</div><div style="font-size:0.7rem; color:#aaa">FONDOS</div></div>
            <div class="dash-card"><div class="dash-val c-r" id="dDebt">$0</div><div style="font-size:0.7rem; color:#aaa">DEUDA</div></div>
            <div class="dash-card"><div class="dash-val c-p" id="dNet">$0</div><div style="font-size:0.7rem; color:#aaa">NETO</div></div>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center; background:#252525; padding:5px 15px; border-radius:8px; margin-bottom:10px;">
            <button class="btn-s" style="width:auto; margin:0" onclick="changeYear(-1)">&lt;</button>
            <span style="font-weight:bold;" id="dispYear">2026</span>
            <button class="btn-s" style="width:auto; margin:0" onclick="changeYear(1)">&gt;</button>
        </div>

        <div class="grid-con">
            <table id="mainTable"></table>
        </div>
        
        <div style="text-align:right; margin-top:5px;">
             <button class="btn-s" style="width:auto; font-size:0.8rem;" onclick="exportExcel()">üì• Descargar Excel</button>
        </div>
    </div>

    <div id="view-cuentas" class="view">
        <button class="btn btn-p" onclick="openModalAcc()">+ Nueva Cuenta</button>
        <div id="accList" style="margin-top:15px;"></div>
    </div>

    <div id="view-config" class="view">
        <div class="dash-card" style="text-align:left;">
            <h3 style="color:#BB86FC">Mi Grupo</h3>
            <p>Nombre: <strong id="confGName" style="color:#fff">...</strong></p>
            <p>Creador: <strong id="confOwner" style="color:#fff">...</strong></p>
            
            <div style="background:#2a2a2a; padding:15px; border-radius:10px; text-align:center; border:1px dashed #555; margin:20px 0;">
                <p style="margin:0; color:#aaa; font-size:0.75rem; text-transform:uppercase;">PIN DE INVITACI√ìN</p>
                <div id="confPin" style="font-size:2.5rem; font-weight:bold; color:#00e676; letter-spacing:5px; margin:5px 0;">****</div>
                <p style="margin:0; font-size:0.8rem; color:#777;">Comparte este PIN para que otros se unan.</p>
            </div>
            
            <hr style="border-color:#333; margin:20px 0;">
            <button class="btn btn-s" onclick="location.reload()">Cambiar de Grupo</button>
            <button class="btn btn-s" style="border-color:#ff5252; color:#ff5252" onclick="logout()">Cerrar Sesi√≥n</button>
        </div>
    </div>

    <div class="footer">
        <div class="cafe-row">
            <a href="https://link.mercadopago.com.ar/cafecitocym" target="_blank" style="flex:2; background:linear-gradient(45deg, #009EE3, #00B1EA); color:#fff; padding:10px; border-radius:20px; text-decoration:none; font-weight:bold; font-size:0.9rem;">‚òï Invitar Cafecito</a>
            <a href="https://wa.me/5492615734341?text=Hola!%20Te%20acabo%20de%20invitar%20un%20cafecito%20en%20la%20App" target="_blank" style="flex:1; background:#25D366; color:#fff; padding:10px; border-radius:20px; text-decoration:none; font-weight:bold; font-size:0.9rem;">üîî Avisar</a>
        </div>
        <div style="font-size:0.7rem; color:#666; font-style:italic;">Ayudame a seguir desarrollando aplicaciones como esta ‚ú®</div>
    </div>

    <button class="fab" onclick="openModalExp()">+</button>

    <div id="modExp" class="modal"><div class="modal-box"><h3>Nuevo Gasto</h3><input id="meName" placeholder="Nombre (ej: Luz)"><select id="meCat"><option>Hogar</option><option>Oficina</option><option>Personal</option><option>Auto</option><option>Tarjetas</option></select><button class="btn btn-p" onclick="saveExp()">Guardar</button><button class="btn btn-s" onclick="closeModal('modExp')">Cancelar</button></div></div>
    
    <div id="modCell" class="modal"><div class="modal-box"><h3>Detalle Pago</h3><label>Monto</label><input type="number" id="mcAmt" style="font-size:1.5rem;color:#BB86FC"><label>D√≠a Venc.</label><input type="number" id="mcDay"><label>Pagar con:</label><select id="mcAcc"><option value="">--</option></select><div style="margin:15px 0; display:flex; gap:10px; align-items:center; background:#333; padding:10px; border-radius:5px;"><input type="checkbox" id="mcPaid" style="width:20px; margin:0;"><label style="margin:0; cursor:pointer;" for="mcPaid">MARCAR COMO PAGADO</label></div><button class="btn btn-p" onclick="saveCell()">Guardar</button><button class="btn btn-s" onclick="closeModal('modCell')">Cancelar</button><button class="btn btn-s" style="color:red; border-color:red;" onclick="delCell()">Borrar</button></div></div>

    <div id="modAcc" class="modal"><div class="modal-box"><h3>Nueva Cuenta</h3><input id="maName" placeholder="Nombre"><input type="number" id="maBal" placeholder="Saldo Inicial"><button class="btn btn-p" onclick="saveAcc()">Guardar</button><button class="btn btn-s" onclick="closeModal('modAcc')">Cancelar</button></div></div>

<script>
    // -----------------------------------------------------------
    // ‚ö†Ô∏è PEGA AQUI TUS CLAVES DE FIREBASE (OBLIGATORIO) 
    // -----------------------------------------------------------
    const firebaseConfig = {
        apiKey: "PEGA_TU_API_KEY_AQUI",
        authDomain: "TU_PROYECTO.firebaseapp.com",
        projectId: "TU_PROJECT_ID",
        storageBucket: "...",
        messagingSenderId: "...",
        appId: "..."
    };
    // -----------------------------------------------------------

    try { firebase.initializeApp(firebaseConfig); } catch(e) { console.error(e); }
    const auth = firebase.auth();
    const db = firebase.firestore();
    
    let currentUser = null;
    let currentGroup = null;
    let appData = { expenses:[], payments:{}, accounts:[] };
    let year = 2026;
    let selCell = null;

    // --- AUTENTICACI√ìN ---
    auth.onAuthStateChanged(user => {
        if(user) {
            currentUser = user;
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('groupScreen').style.display = 'flex';
            document.getElementById('dispUserEmail').innerText = user.email.split('@')[0];
        } else {
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('groupScreen').style.display = 'none';
            document.querySelector('.app-header').style.display = 'none';
        }
    });

    function loginEmail() {
        const e = document.getElementById('email').value;
        const p = document.getElementById('password').value;
        auth.signInWithEmailAndPassword(e, p).catch(e => document.getElementById('authMsg').innerText=e.message);
    }
    function registerEmail() {
        const e = document.getElementById('email').value;
        const p = document.getElementById('password').value;
        auth.createUserWithEmailAndPassword(e, p).catch(e => document.getElementById('authMsg').innerText=e.message);
    }
    function loginGoogle() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch(e => document.getElementById('authMsg').innerText=e.message);
    }
    function logout() { auth.signOut().then(() => location.reload()); }

    // --- LOGICA DE GRUPOS (Seguridad) ---
    function checkGroup() {
        const name = document.getElementById('groupNameInput').value.trim().toUpperCase();
        if(name.length < 3) return document.getElementById('groupMsg').innerText = "Nombre muy corto";
        const pinInput = document.getElementById('groupPinInput').value.trim();

        document.getElementById('groupMsg').innerText = "Verificando...";

        db.collection('groups').doc(name).get().then(doc => {
            if(doc.exists) {
                // El grupo existe
                const gInfo = doc.data();
                const isMember = gInfo.members.includes(currentUser.email);
                
                if(isMember) {
                    enterGroup(name, gInfo);
                } else {
                    // No es miembro, pedir PIN
                    document.getElementById('pinArea').style.display = 'block';
                    document.getElementById('groupMsg').innerText = "";
                    
                    if(pinInput === gInfo.pin) {
                        // PIN OK -> Agregar a miembros
                        db.collection('groups').doc(name).update({
                            members: firebase.firestore.FieldValue.arrayUnion(currentUser.email)
                        }).then(() => enterGroup(name, gInfo));
                    } else if(pinInput.length > 0) {
                        document.getElementById('groupMsg').innerText = "PIN INCORRECTO";
                    }
                }
            } else {
                // El grupo NO existe -> Crear
                if(confirm("El grupo no existe. ¬øCrearlo y ser el Due√±o?")) {
                    const newPin = Math.floor(1000 + Math.random() * 9000).toString();
                    const newGroup = {
                        owner: currentUser.email,
                        members: [currentUser.email],
                        pin: newPin,
                        createdAt: new Date().toISOString()
                    };
                    db.collection('groups').doc(name).set(newGroup).then(() => {
                        enterGroup(name, newGroup);
                    });
                } else {
                    document.getElementById('groupMsg').innerText = "";
                }
            }
        });
    }

    function enterGroup(name, info) {
        currentGroup = name;
        document.getElementById('groupScreen').style.display = 'none';
        document.querySelector('.app-header').style.display = 'flex';
        document.getElementById('dispGroupName').innerText = name;
        
        // Datos Config
        document.getElementById('confGName').innerText = name;
        document.getElementById('confOwner').innerText = info.owner;
        document.getElementById('confPin').innerText = info.pin;

        // Cargar Datos
        db.collection('data').doc(name).onSnapshot(doc => {
            if(doc.exists) {
                appData = doc.data();
                if(!appData.expenses) appData.expenses = [];
                if(!appData.payments) appData.payments = {};
                if(!appData.accounts) appData.accounts = [];
            } else {
                saveData(); // Crear doc vac√≠o
            }
            renderAll();
        });
    }

    function saveData() {
        if(!currentGroup) return;
        db.collection('data').doc(currentGroup).set(appData);
    }

    // --- RENDERIZADO UI ---
    function renderAll() { renderGrid(); renderAcc(); calcDash(); }
    
    function renderGrid() {
        const t = document.getElementById('mainTable');
        t.innerHTML = `<thead><tr><th class="col-fix">Concepto</th>${[...Array(12)].map((_,i)=>`<th>${new Date(year,i,1).toLocaleDateString('es-ES',{month:'short'}).toUpperCase()}</th>`).join('')}</tr></thead>`;
        let body = '<tbody>';
        
        // Ordenar gastos (opcional: por nombre)
        appData.expenses.forEach(e => {
            body += `<tr><td class="col-fix"><b>${e.name}</b><br><span style="font-size:0.7rem;color:#aaa">${e.cat}</span></td>`;
            for(let i=0; i<12; i++) {
                const k = `${e.id}_${year}_${i}`;
                const p = appData.payments[k] || {};
                const st = p.paid ? 'status-paid' : (p.amt ? 'status-pend' : '');
                body += `<td class="${st}"><div onclick="openCell(${e.id},${i})" style="height:100%;display:flex;flex-direction:column;justify-content:center;align-items:center;cursor:pointer;">${p.amt ? '$'+parseInt(p.amt).toLocaleString() : ''}<span style="font-size:0.6rem">${p.day?'D√≠a '+p.day:''}</span></div></td>`;
            }
            body += '</tr>';
        });
        t.innerHTML += body + '</tbody>';
    }

    function renderAcc() {
        const l = document.getElementById('accList'); l.innerHTML = '';
        const s = document.getElementById('mcAcc'); s.innerHTML = '<option value="">--</option>';
        appData.accounts.forEach(a => {
            s.innerHTML += `<option value="${a.id}">${a.name}</option>`;
            l.innerHTML += `<div class="dash-card" style="margin-bottom:5px; display:flex; justify-content:space-between; align-items:center;"><div><b>${a.name}</b></div><div style="color:#00e676">$${parseInt(a.bal).toLocaleString()} <span onclick="delAcc(${a.id})" style="color:red; cursor:pointer; margin-left:10px;">‚úñ</span></div></div>`;
        });
    }

    function calcDash() {
        let debt=0, assets=0;
        const now = new Date();
        // Deuda de este mes
        appData.expenses.forEach(e => {
            const k = `${e.id}_${now.getFullYear()}_${now.getMonth()}`;
            const p = appData.payments[k];
            if(p && p.amt && !p.paid) debt += parseInt(p.amt);
        });
        appData.accounts.forEach(a => assets += parseInt(a.bal));
        document.getElementById('dTotal').innerText = '$'+assets.toLocaleString();
        document.getElementById('dDebt').innerText = '$'+debt.toLocaleString();
        document.getElementById('dNet').innerText = '$'+(assets-debt).toLocaleString();
    }

    // --- CRUD ---
    function openModalExp() { document.getElementById('modExp').style.display='flex'; }
    function saveExp() {
        const n=document.getElementById('meName').value;
        if(n) { appData.expenses.push({id:Date.now(), name:n, cat:document.getElementById('meCat').value}); saveData(); closeModal('modExp'); document.getElementById('meName').value=''; }
    }
    function openModalAcc() { document.getElementById('modAcc').style.display='flex'; }
    function saveAcc() {
        const n=document.getElementById('maName').value; const b=document.getElementById('maBal').value;
        if(n) { appData.accounts.push({id:Date.now(), name:n, bal:b||0}); saveData(); closeModal('modAcc'); document.getElementById('maName').value=''; }
    }
    function delAcc(id) { if(confirm("¬øBorrar?")) { appData.accounts = appData.accounts.filter(a=>a.id!==id); saveData(); } }

    function openCell(eid, m) {
        selCell = {eid, m}; const k = `${eid}_${year}_${m}`; const p = appData.payments[k] || {};
        document.getElementById('mcAmt').value = p.amt||'';
        document.getElementById('mcDay').value = p.day||'';
        document.getElementById('mcAcc').value = p.accId||'';
        document.getElementById('mcPaid').checked = p.paid||false;
        document.getElementById('modCell').style.display='flex';
    }
    function saveCell() {
        const k = `${selCell.eid}_${year}_${selCell.m}`;
        const amt = document.getElementById('mcAmt').value;
        if(amt) {
            appData.payments[k] = { 
                amt: amt, 
                day: document.getElementById('mcDay').value,
                accId: document.getElementById('mcAcc').value,
                paid: document.getElementById('mcPaid').checked
            };
        } else delete appData.payments[k];
        saveData(); closeModal('modCell');
    }
    function delCell() { delete appData.payments[`${selCell.eid}_${year}_${selCell.m}`]; saveData(); closeModal('modCell'); }

    // UTILS
    function switchTab(t) { document.querySelectorAll('.view').forEach(v=>v.classList.remove('active')); document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); document.getElementById('view-'+t).classList.add('active'); event.target.classList.add('active'); if(t==='planilla') renderAll(); }
    function changeYear(d) { year+=d; document.getElementById('dispYear').innerText=year; renderAll(); }
    function closeModal(id) { document.getElementById(id).style.display='none'; }
    function exportExcel() { const ws=XLSX.utils.table_to_sheet(document.getElementById('mainTable')); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Pagos"); XLSX.writeFile(wb,"Pagos.xlsx"); }
</script>
</body>
</html>