<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Armado de Pagos</title>
    
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <style>
        /* ESTILOS (Dark Theme) */
        body { font-family: 'Segoe UI', Roboto, sans-serif; background-color: #121212; color: #eee; margin: 0; padding-bottom: 150px; display: flex; flex-direction: column; align-items: center; }
        a { text-decoration: none; color: inherit; }

        /* HEADER */
        .app-header { width: 100%; background: #1e1e1e; padding: 10px 20px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; box-sizing: border-box; position: sticky; top: 0; z-index: 100; }
        .logo-area { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .logo-img { height: 45px; border-radius: 8px; border: 1px solid #444; }
        .app-info { display:flex; flex-direction:column; }
        .app-name { font-weight: 800; font-size: 1rem; color: #fff; line-height:1.1; }
        .app-sub { font-size: 0.75rem; color: #BB86FC; font-weight: bold; letter-spacing: 1px; }
        
        .user-badge { text-align: right; }
        .user-email { color: #ccc; font-size: 0.75rem; }
        .group-tag { background: #333; color: #ccc; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: bold; display: inline-block; margin-top: 2px; border: 1px solid #555; }
        .group-tag.pro { background: linear-gradient(45deg, #00e676, #00c853); color: #000; border: none; box-shadow: 0 0 10px rgba(0,230,118,0.3); }
        .group-tag.expired { background: #ff5252; color: #fff; border: none; }

        /* PANTALLAS */
        #authScreen, #groupScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #050505; z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .auth-box { background: #1e1e1e; padding: 30px; border-radius: 15px; border: 1px solid #333; width: 90%; max-width: 350px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .auth-btn { width: 100%; padding: 12px; margin-top: 10px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-google { background: #fff; color: #333; display: flex; align-items: center; justify-content: center; gap: 10px; font-family: Roboto, sans-serif; }
        
        .pass-wrapper { position: relative; width: 100%; }
        .pass-toggle { position: absolute; right: 15px; top: 15px; cursor: pointer; color: #aaa; font-size: 1.2rem; }

        /* UI GENERAL */
        .tabs { display: flex; width: 95%; max-width: 1400px; margin: 15px auto; background: #252525; border-radius: 12px; border: 1px solid #333; overflow: hidden; }
        .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; color: #888; font-weight: 600; }
        .tab.active { background: #BB86FC; color: #000; font-weight: 800; }
        #tab-admin { display: none; background: #330000; color: #ff5252; } 
        
        .view { display: none; width: 95%; max-width: 1400px; margin: 0 auto; flex-direction: column; gap: 15px; }
        .view.active { display: flex; }

        .dashboard-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .dash-card { background: #1e1e1e; padding: 15px; border-radius: 12px; border: 1px solid #333; text-align: center; }
        .dash-val { font-size: 1.1rem; font-weight: bold; font-family: monospace; margin-top:5px; }
        .c-g { color: #00e676; } .c-r { color: #ff5252; } .c-p { color: #BB86FC; }

        /* TABLA */
        .grid-con { overflow-x: auto; background: #1e1e1e; border-radius: 8px; border: 1px solid #333; min-height: 300px; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 900px; }
        th { background: #252525; position: sticky; top: 0; padding: 10px; color: #aaa; border-bottom: 2px solid #444; z-index: 20; cursor: pointer; user-select: none; }
        th:hover { background: #333; color: #fff; }
        td { border-bottom: 1px solid #333; border-right: 1px solid #333; height: 55px; vertical-align: middle; }
        .col-fix { position: sticky; left: 0; background: #1e1e1e; border-right: 2px solid #444 !important; z-index: 30; min-width: 160px; max-width: 160px; }
        
        /* CUENTAS ACORDEON */
        .acc-card { background: #1e1e1e; border-radius: 10px; border: 1px solid #333; margin-bottom: 10px; overflow: hidden; }
        .acc-head { display: flex; justify-content: space-between; align-items: center; padding: 15px; cursor: pointer; }
        .acc-detail { display: none; background: #151515; padding: 15px; border-top: 1px solid #333; }
        .acc-detail.open { display: block; animation: fadeIn 0.3s; }
        .det-row { display: flex; justify-content: space-between; font-size: 0.85rem; padding: 5px 0; border-bottom: 1px solid #2a2a2a; color: #ccc; }
        .det-total { border-top: 1px solid #555; border-bottom: none; font-weight: bold; font-size: 1rem; margin-top: 10px; padding-top: 10px; color: #BB86FC; }
        @keyframes fadeIn { from {opacity:0} to {opacity:1} }

        /* ADMIN */
        .admin-controls { display:flex; gap:10px; justify-content:center; margin-bottom:15px; background:#2a2a2a; padding:10px; border-radius:8px; }
        .admin-table { width: 100%; min-width: 300px; border-collapse: collapse; }
        .admin-table th { text-align: left; color: #BB86FC; padding: 10px; border-bottom: 2px solid #444; }
        .admin-table td { padding: 10px; border-bottom: 1px solid #333; font-size: 0.9rem; vertical-align: top; }
        .tag-adm { padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; white-space: nowrap; cursor: pointer;}
        .del-user { color: #ff5252; cursor: pointer; font-weight: bold; margin-left: 5px; }
        .add-user { color: #00e676; cursor: pointer; font-size: 0.8rem; border: 1px solid #00e676; padding: 2px 5px; border-radius: 5px; display:inline-block; margin-top:5px; }

        /* Stats Grid Admin */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; }
        .stat-box { background: #2a2a2a; padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #444; }
        .stat-num { font-size: 1.2rem; font-weight: bold; color: #fff; }
        .stat-label { font-size: 0.7rem; color: #aaa; text-transform: uppercase; }

        /* FOOTER */
        .footer { position: fixed; bottom: 0; width: 100%; background: #1a1a1a; padding: 15px; border-top: 1px solid #333; text-align: center; z-index: 50; display:flex; flex-direction:column; gap:10px; align-items:center; }
        .cafe-row { display: flex; gap: 10px; justify-content: center; width: 100%; max-width: 400px; }
        
        /* UTILIDADES */
        .btn { padding: 10px; width: 100%; border-radius: 5px; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-p { background: #BB86FC; color: #000; }
        .btn-s { background: #333; color: #ccc; border: 1px solid #555; }
        .btn-d { background: #330000; color: #ff5252; border: 1px solid #ff5252; }
        .btn-tool { background: transparent; border: 1px solid #555; color: #aaa; padding: 8px; font-size: 0.8rem; border-radius: 5px; cursor: pointer; flex: 1; }
        
        input, select { width: 100%; padding: 12px; margin: 5px 0 15px 0; background: #151515; border: 1px solid #444; color: #fff; border-radius: 5px; box-sizing: border-box; }
        .fab { position: fixed; bottom: 120px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background: #BB86FC; color: #000; font-size: 2rem; border: none; cursor: pointer; display: flex; justify-content: center; align-items: center; z-index: 60; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; justify-content: center; align-items: center; }
        .modal-box { background: #252525; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; border: 1px solid #555; max-height: 90vh; overflow-y: auto; }

        .status-paid { background: rgba(0, 230, 118, 0.15); border-left: 3px solid #00e676; }
        .status-pend { background: rgba(255, 82, 82, 0.15); border-left: 3px solid #ff5252; }
        .expense-name { font-weight:bold; font-size:0.9rem; display:block; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        .icon-btn { cursor:pointer; margin-left:5px; opacity:0.7; } .icon-btn:hover { opacity:1; }
        
        /* PRICE UI */
        .price-display { color: #00e676; font-weight: bold; font-size: 1.1rem; text-align: center; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="authScreen">
        <div class="auth-box">
            <a href="https://www.cymaplicaciones.com">
                <img src="logo.jpg" style="height:70px; border-radius:10px; margin-bottom:15px; border:1px solid #444;">
            </a>
            <h2 style="color:#BB86FC; margin:0;">Armado de Pagos</h2>
            <p style="color:#aaa; font-size:0.9rem;">Accede a tu panel de control</p>
            
            <input type="email" id="email" placeholder="Correo electr√≥nico">
            
            <div class="pass-wrapper">
                <input type="password" id="password" placeholder="Contrase√±a">
                <span class="pass-toggle" onclick="togglePass()">üëÅÔ∏è</span>
            </div>
            
            <div style="text-align:right; margin-bottom:15px;">
                <span onclick="resetPass()" style="font-size:0.75rem; color:#BB86FC; cursor:pointer; text-decoration:underline;">¬øOlvidaste tu contrase√±a?</span>
            </div>

            <button class="auth-btn btn-p" onclick="loginEmail()">Iniciar Sesi√≥n</button>
            <button class="auth-btn btn-s" onclick="registerEmail()">Crear Cuenta</button>
            
            <div style="margin:20px 0; border-top:1px solid #333; padding-top:15px; color:#555; font-size:0.8rem;">O CONTINUA CON</div>
            <button class="auth-btn btn-google" onclick="loginGoogle()">
                <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" width="20"> 
                <span style="font-weight:500;">Acceder con Google</span>
            </button>
            <p id="authMsg" style="color:#ff5252; margin-top:10px; font-size:0.9rem;"></p>
        </div>
    </div>

    <div id="groupScreen" style="display:none;">
        <div class="auth-box">
            <a href="https://www.cymaplicaciones.com">
                <img src="logo.jpg" style="height:50px; border-radius:10px; margin-bottom:10px;">
            </a>
            <h2 style="color:#BB86FC;">Seleccionar Grupo</h2>
            <p style="color:#aaa;">Ingresa el nombre de tu grupo/familia</p>
            <input type="text" id="groupNameInput" placeholder="Ej: FLIA_PEREZ" style="text-transform:uppercase; text-align:center; font-size:1.2rem; letter-spacing:1px;">
            
            <div id="pinArea" style="display:none; background:#2a2a2a; padding:15px; border-radius:8px; margin-bottom:15px; border:1px solid #444;">
                <p style="margin:0 0 5px 0; font-size:0.9rem; color:#ffb74d;">üîí Grupo Privado</p>
                <input type="text" id="groupPinInput" placeholder="PIN" style="text-align:center; letter-spacing:5px; font-size:1.5rem; width:100px; margin:0 auto;">
            </div>

            <button class="auth-btn btn-p" onclick="checkGroup()">ENTRAR</button>
            <button class="auth-btn btn-s" style="margin-top:20px;" onclick="logout()">Cerrar Sesi√≥n</button>
            <p id="groupMsg" style="color:#ff5252; margin-top:10px; font-size:0.9rem;"></p>
        </div>
    </div>

    <div class="app-header">
        <a href="https://www.cymaplicaciones.com" class="logo-area">
            <img src="logo.jpg" class="logo-img" alt="Logo">
            <div class="app-info">
                <span class="app-name">Armado de Pagos</span>
                <span class="app-sub" id="headerGroupName">...</span>
            </div>
        </a>
        <div class="user-badge">
            <div class="user-email" id="dispUserEmail">...</div>
            <div class="group-tag" id="dispGroupTag">GRATIS</div>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('planilla')">üìù Planilla</div>
        <div class="tab" onclick="switchTab('cuentas')">üí≥ Cuentas</div>
        <div class="tab" onclick="switchTab('help')">‚ùì Ayuda</div>
        <div class="tab" onclick="switchTab('config')">‚öôÔ∏è Config</div>
        <div class="tab" id="tab-admin" onclick="switchTab('admin')">üîí Admin</div>
    </div>

    <div id="view-planilla" class="view active">
        <div class="dashboard-grid">
            <div class="dash-card"><div class="dash-val c-g" id="dTotal">$0</div><div style="font-size:0.7rem; color:#aaa">FONDOS</div></div>
            <div class="dash-card"><div class="dash-val c-r" id="dDebt">$0</div><div style="font-size:0.7rem; color:#aaa">DEUDA</div></div>
            <div class="dash-card"><div class="dash-val c-p" id="dNet">$0</div><div style="font-size:0.7rem; color:#aaa">NETO</div></div>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center; background:#252525; padding:5px 15px; border-radius:8px; margin-bottom:10px;">
            <button class="btn-s" style="width:auto; margin:0" onclick="changeYear(-1)">&lt;</button>
            <span style="font-weight:bold;" id="dispYear">2026</span>
            <button class="btn-s" style="width:auto; margin:0" onclick="changeYear(1)">&gt;</button>
        </div>

        <div class="grid-con">
            <table id="mainTable"></table>
        </div>
        
        <div style="text-align:right; margin-top:5px;">
             <button class="btn-s" style="width:auto; font-size:0.8rem;" onclick="exportExcel()">üì• Descargar Excel</button>
        </div>
    </div>

    <div id="view-cuentas" class="view">
        <button class="btn btn-p" onclick="openModalAcc()">+ Nueva Cuenta</button>
        <div id="accList" style="margin-top:15px;"></div>
    </div>

    <div id="view-help" class="view">
        <div class="dash-card" style="text-align:left;">
            <h3 style="color:#BB86FC;">üìñ Manual de Uso</h3>
            <p><strong>1. Carga tu Dinero:</strong> Ve a la pesta√±a "Cuentas" y carga tus saldos reales (Banco, Efectivo).</p>
            <p><strong>2. Define tus Gastos:</strong> Usa el bot√≥n (+) para crear tus gastos fijos. Puedes agregar links, usuarios y claves.</p>
            <p><strong>3. Planifica:</strong> En la Planilla, toca el mes correspondiente para cargar importe y vencimiento. Asigna con qu√© cuenta pagar√°s.</p>
            
            <hr style="border-color:#333; margin:20px 0;">
            
            <h3 style="color:#00e676;">üëë Plan PRO (<span class="uiPriceDisplay">$...</span>/mes)</h3>
            <p>Todos los grupos nuevos tienen <strong>30 d√≠as de prueba gratuita</strong> con acceso total.</p>
            <p><strong>¬øC√≥mo renovar?</strong></p>
            <ol>
                <li>Al finalizar el periodo, realiza el pago del mes.</li>
                <li>Env√≠a el comprobante por WhatsApp.</li>
                <li>Recibir√°s una <strong>Clave Mensual</strong> √∫nica.</li>
                <li>Ingresa la clave en "Configuraci√≥n" y se habilitar√° ese mes.</li>
            </ol>
        </div>
    </div>

    <div id="view-config" class="view">
        
        <div class="dash-card" style="text-align:left; margin-bottom:15px; border-color:#00e676;">
            <h3 style="color:#00e676; margin-top:0;">‚ôªÔ∏è Migraci√≥n de Datos</h3>
            <div style="display:flex; gap:10px;">
                <button class="btn-tool" onclick="downloadBackup()">üíæ Crear Backup</button>
                <button class="btn-tool" onclick="document.getElementById('restInput').click()">üìÇ Restaurar Backup</button>
                <input type="file" id="restInput" style="display:none" onchange="restoreBackup(this)">
            </div>
        </div>

        <div class="dash-card" style="text-align:left; border-color:#ff5252;">
            <h3 style="color:#ff5252; margin-top:0;">‚ò†Ô∏è Zona de Peligro</h3>
            <p style="font-size:0.8rem; color:#aaa;">Estas acciones no se pueden deshacer.</p>
            <button class="btn btn-d" onclick="nukeExpenses()">üóëÔ∏è Borrar TODOS los Gastos</button>
            <button class="btn btn-d" onclick="nukeAccounts()">üóëÔ∏è Borrar TODAS las Cuentas</button>
        </div>

        <div class="dash-card" style="text-align:left; margin-top:15px;">
            <h3 style="color:#BB86FC">Mi Grupo</h3>
            <p>Nombre: <strong id="confGName" style="color:#fff">...</strong></p>
            <p>Vencimiento: <strong id="confValid" style="color:#fff">...</strong></p>
            
            <div style="background:#2a2a2a; padding:15px; border-radius:10px; text-align:center; border:1px dashed #555; margin:20px 0;">
                <p style="margin:0; color:#aaa; font-size:0.75rem; text-transform:uppercase;">PIN DE INVITACI√ìN</p>
                <div id="confPin" style="font-size:2.5rem; font-weight:bold; color:#00e676; letter-spacing:5px; margin:5px 0;">****</div>
                <p style="margin:0; font-size:0.8rem; color:#777;">Comparte este PIN.</p>
            </div>
            
            <div style="margin-top:15px; padding-top:15px; border-top:1px solid #333;">
                <p style="font-size:0.85rem; color:#aaa;">Pagar Suscripci√≥n / Canjear:</p>
                
                <div class="price-display">Valor Mensual: <span class="uiPriceDisplay">$...</span></div>

                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <a href="https://link.mercadopago.com.ar/cafecitocym" target="_blank" class="btn btn-p" style="margin:0; text-align:center; background:#009EE3; color:white;">Pagar con MP</a>
                    <a href="https://wa.me/5492615734341?text=Hola!%20Ya%20hice%20el%20pago%20de%20mi%20grupo,%20envio%20comprobante." target="_blank" class="btn btn-s" style="margin:0; text-align:center; background:#25D366; color:white; border:none;">Enviar Comprobante</a>
                </div>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="unlockCode" placeholder="INGRESAR C√ìDIGO MES/A√ëO" style="margin:0; text-align:center;">
                    <button class="btn-p" style="margin:0; width:auto;" onclick="unlockPro()">OK</button>
                </div>
            </div>

            <hr style="border-color:#333; margin:20px 0;">
            <button class="btn btn-s" onclick="location.reload()">Cambiar de Grupo</button>
            <button class="btn btn-s" style="border-color:#ff5252; color:#ff5252" onclick="logout()">Cerrar Sesi√≥n</button>
        </div>
    </div>

    <div id="view-admin" class="view">
        <h2 style="color:#ff5252; text-align:center;">PANEL ADMINISTRADOR</h2>
        
        <div class="stats-grid" id="adminStats">
            <div class="stat-box">
                <div class="stat-num" id="statUsers">0</div>
                <div class="stat-label">Usuarios</div>
            </div>
            <div class="stat-box">
                <div class="stat-num" id="statGroups">0</div>
                <div class="stat-label">Grupos</div>
            </div>
            <div class="stat-box" style="border-color:#00e676;">
                <div class="stat-num" style="color:#00e676;" id="statActive">0</div>
                <div class="stat-label">Activos</div>
            </div>
            <div class="stat-box" style="border-color:#ff5252;">
                <div class="stat-num" style="color:#ff5252;" id="statExpired">0</div>
                <div class="stat-label">Vencidos</div>
            </div>
        </div>

        <div class="dash-card" style="text-align:left; border-color:#BB86FC; margin-bottom:15px;">
            <p><b style="color:#BB86FC">Configuraci√≥n Global</b></p>
            <label>Precio Suscripci√≥n:</label>
            <div style="display:flex; gap:5px;">
                <input type="number" id="adminPriceInput" placeholder="Ej: 6000">
                <button class="btn-p" style="width:auto; margin:0;" onclick="savePrice()">Guardar</button>
            </div>
        </div>

        <div class="dash-card" style="text-align:left;">
            <p><b>Generador de Claves Mensuales</b></p>
            <div class="admin-controls">
                <select id="adminMonth">
                    <option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option>
                    <option value="3">Abril</option><option value="4">Mayo</option><option value="5">Junio</option>
                    <option value="6">Julio</option><option value="7">Agosto</option><option value="8">Septiembre</option>
                    <option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option>
                </select>
                <select id="adminYear"></select> 
            </div>
            <p style="font-size:0.8rem; color:#aaa;">Selecciona Mes/A√±o y toca "üîë Clave" en el usuario.</p>
            <button class="btn btn-s" onclick="renderAdmin()">üîÑ Actualizar Lista</button>
        </div>
        <div id="adminList"></div>
    </div>

    <div class="footer">
        <div class="cafe-row">
            <a href="https://link.mercadopago.com.ar/cafecitocym" target="_blank" style="flex:2; background:linear-gradient(45deg, #009EE3, #00B1EA); color:#fff; padding:10px; border-radius:20px; text-decoration:none; font-weight:bold; font-size:0.9rem;">‚òï Invitar Cafecito</a>
            <a href="https://wa.me/5492615734341?text=Hola!%20Te%20acabo%20de%20invitar%20un%20cafecito%20en%20la%20App" target="_blank" style="flex:1; background:#25D366; color:#fff; padding:10px; border-radius:20px; text-decoration:none; font-weight:bold; font-size:0.9rem;">üîî Avisar</a>
        </div>
        <div style="font-size:0.7rem; color:#666; font-style:italic;">Ayudame a seguir desarrollando aplicaciones como esta ‚ú®</div>
    </div>

    <button class="fab" onclick="openModalExp()">+</button>

    <div id="modExp" class="modal">
        <div class="modal-box">
            <h3>Gasto / Servicio</h3>
            <label>Nombre:</label>
            <input id="meName" placeholder="Ej: Luz Casa">
            <label>Categor√≠a:</label>
            <select id="meCat"><option>Hogar</option><option>Oficina</option><option>Personal</option><option>Auto</option><option>Tarjetas</option></select>
            
            <label>Link Carpeta Comprobantes:</label>
            <input id="meFolder" placeholder="https://drive.google.com...">
            <label>Link de Pago (Web):</label>
            <input id="meLink" placeholder="https://...">
            
            <div style="background:#333; padding:10px; border-radius:5px; margin-bottom:10px;">
                <label style="color:#BB86FC; font-size:0.8rem;">Credenciales (Opcional):</label>
                <input id="meUser" placeholder="Usuario / ID" style="margin-bottom:5px;">
                <input id="mePass" placeholder="Contrase√±a">
            </div>
            
            <label>Comentarios:</label>
            <input id="meComm" placeholder="...">
            
            <button class="btn btn-p" onclick="saveExp()">Guardar</button>
            <button class="btn btn-s" onclick="closeModal('modExp')">Cancelar</button>
            <button class="btn btn-d" style="margin-top:15px;" onclick="delExp()">üóëÔ∏è Borrar Gasto y Pagos</button>
        </div>
    </div>
    
    <div id="modCell" class="modal"><div class="modal-box"><h3>Detalle Pago</h3><label>Monto (Ej: 100+50)</label><input type="text" id="mcAmt" onchange="calcInput(this)" style="font-size:1.5rem;color:#BB86FC" placeholder="0"><label>D√≠a Venc.</label><input type="number" id="mcDay" placeholder="D√≠a (1-31)"><label>Pagar con:</label><select id="mcAcc"><option value="">--</option></select><div style="margin:15px 0; display:flex; gap:10px; align-items:center; background:#333; padding:10px; border-radius:5px;"><input type="checkbox" id="mcPaid" style="width:20px; margin:0;"><label style="margin:0; cursor:pointer;" for="mcPaid">MARCAR COMO PAGADO</label></div><button class="btn btn-p" onclick="saveCell()">Guardar</button><button class="btn btn-s" onclick="closeModal('modCell')">Cancelar</button><button class="btn btn-s" style="color:red; border-color:red;" onclick="delCell()">Borrar</button></div></div>

    <div id="modAcc" class="modal"><div class="modal-box"><h3>Nueva Cuenta</h3><input id="maName" placeholder="Nombre"><input type="text" id="maBal" onchange="calcInput(this)" placeholder="Saldo Inicial (Ej: 5000+200)"><button class="btn btn-p" onclick="saveAcc()">Guardar</button><button class="btn btn-s" onclick="closeModal('modAcc')">Cancelar</button></div></div>

    <div id="modLock" class="modal" style="z-index:9999;">
        <div class="modal-box" style="border:2px solid #ff5252;">
            <h2 style="color:#ff5252">‚ö†Ô∏è Servicio Vencido</h2>
            <p>El periodo de uso ha finalizado.</p>
            <p>Por favor, ingresa el c√≥digo de renovaci√≥n para continuar operando.</p>
            <div class="price-display">Valor Actual: <span class="uiPriceDisplay">$...</span></div>
            <p style="font-size:0.8rem; color:#aaa;">C√≥digo DEMO disponible: "DEMO"</p>
            <button class="btn btn-p" onclick="closeModal('modLock'); switchTab('config');">Ir a Pagar</button>
        </div>
    </div>

<script>
    // -----------------------------------------------------------
    // ‚ö†Ô∏è PEGA AQUI TUS CLAVES DE FIREBASE
    // -----------------------------------------------------------
const firebaseConfig = {
  apiKey: "AIzaSyA79gsaESM8m_9jJY-lYHHHHbIxkGeJ9jA",
  authDomain: "armadopagos.firebaseapp.com",
  projectId: "armadopagos",
  storageBucket: "armadopagos.firebasestorage.app",
  messagingSenderId: "482082107729",
  appId: "1:482082107729:web:e4f29ee165ca1437e76370"
};
    // -----------------------------------------------------------

    try { firebase.initializeApp(firebaseConfig); } catch(e) { console.error(e); }
    const auth = firebase.auth();
    const db = firebase.firestore();
    
    // --- VARIABLES GLOBALES ---
    const ADMIN_EMAIL = "diegomatteiblanco@gmail.com";
    let currentUser = null;
    let currentGroup = null;
    let groupInfo = null;
    let appData = { expenses:[], payments:{}, accounts:[] };
    let year = 2026;
    let selCell = null;
    let isExpired = false;
    let globalPrice = 0; 

    // --- HELPER CALCULADORA ---
    function smartParse(str) {
        try {
            if(!str) return 0;
            let clean = str.toString().replace(/,/g, '.').replace(/[^-()\d/*+.]/g, '');
            return eval(clean) || 0;
        } catch(e) { return 0; }
    }
    
    function calcInput(el) {
        const val = smartParse(el.value);
        if(val) el.value = val;
    }

    // --- INICIALIZACION ---
    db.collection('config').doc('pricing').onSnapshot(doc => {
        if(doc.exists) {
            globalPrice = doc.data().val || 0;
            document.querySelectorAll('.uiPriceDisplay').forEach(el => {
                el.innerText = '$' + parseInt(globalPrice).toLocaleString();
            });
        }
    });

    // --- AUTENTICACI√ìN ---
    auth.onAuthStateChanged(user => {
        if(user) {
            currentUser = user;
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('groupScreen').style.display = 'flex';
            document.getElementById('dispUserEmail').innerText = user.email.split('@')[0];
            
            if(user.email === ADMIN_EMAIL) {
                document.getElementById('tab-admin').style.display = 'block';
                const hoy = new Date();
                document.getElementById('adminMonth').value = hoy.getMonth();
            }
        } else {
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('groupScreen').style.display = 'none';
            document.querySelector('.app-header').style.display = 'none';
        }
    });

    function togglePass() {
        const x = document.getElementById("password");
        x.type = (x.type === "password") ? "text" : "password";
    }

    function loginEmail() { auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value).catch(e => document.getElementById('authMsg').innerText=e.message); }
    function registerEmail() { auth.createUserWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value).catch(e => document.getElementById('authMsg').innerText=e.message); }
    function loginGoogle() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e => document.getElementById('authMsg').innerText=e.message); }
    function resetPass() { const e=document.getElementById('email').value; if(!e) return alert("Ingresa tu correo arriba"); auth.sendPasswordResetEmail(e).then(()=>alert("Revisa tu correo (y SPAM)")).catch(e=>alert(e.message)); }
    function logout() { auth.signOut().then(() => location.reload()); }

    // --- GRUPOS Y VALIDACION ---
    function checkGroup() {
        const name = document.getElementById('groupNameInput').value.trim().toUpperCase();
        if(name.length < 3) return document.getElementById('groupMsg').innerText = "Nombre muy corto";
        const pin = document.getElementById('groupPinInput').value.trim();

        db.collection('groups').doc(name).get().then(doc => {
            if(doc.exists) {
                const g = doc.data();
                if(currentUser.email === ADMIN_EMAIL || g.members.includes(currentUser.email)) {
                    enterGroup(name, g);
                } else {
                    document.getElementById('pinArea').style.display='block';
                    if(pin === g.pin) {
                        db.collection('groups').doc(name).update({
                            members: firebase.firestore.FieldValue.arrayUnion(currentUser.email)
                        }).then(() => enterGroup(name, g));
                    } else if(pin) document.getElementById('groupMsg').innerText = "PIN INCORRECTO";
                }
            } else {
                if(confirm("Crear grupo nuevo?")) {
                    const expDate = new Date(); expDate.setDate(expDate.getDate() + 30);
                    const newG = { owner: currentUser.email, members: [currentUser.email], pin: Math.floor(1000+Math.random()*9000).toString(), validUntil: expDate.toISOString() };
                    db.collection('groups').doc(name).set(newG).then(() => enterGroup(name, newG));
                }
            }
        });
    }

    function enterGroup(name, info) {
        currentGroup = name;
        groupInfo = info;
        document.getElementById('groupScreen').style.display = 'none';
        document.querySelector('.app-header').style.display = 'flex';
        document.getElementById('headerGroupName').innerText = name;
        
        // ESCUCHA EN VIVO DEL ESTADO DEL GRUPO (Fecha vencimiento)
        db.collection('groups').doc(name).onSnapshot(doc => {
            if(doc.exists) {
                const g = doc.data();
                updateBadge(g.validUntil);
            }
        });

        // Config Inicial Badge
        updateBadge(info.validUntil);

        document.getElementById('confGName').innerText = name;
        document.getElementById('confPin').innerText = info.pin;

        // Escucha de DATOS (Gastos, Pagos)
        db.collection('data').doc(name).onSnapshot(doc => {
            if(doc.exists) {
                appData = doc.data();
                if(!appData.expenses) appData.expenses = [];
                if(!appData.payments) appData.payments = {};
                if(!appData.accounts) appData.accounts = [];
            } else saveData();
            renderAll();
        });
    }

    function updateBadge(validUntil) {
        const validDate = new Date(validUntil || 0);
        const now = new Date();
        const diffDays = Math.ceil((validDate - now) / (1000 * 60 * 60 * 24));
        isExpired = diffDays <= 0;
        
        const tag = document.getElementById('dispGroupTag');
        document.getElementById('confValid').innerText = validDate.toLocaleDateString();

        if(isExpired) {
            tag.innerText = "VENCIDO"; tag.className = "group-tag expired";
            document.getElementById('confValid').innerText = "VENCIDO - PAGO REQUERIDO";
            document.getElementById('confValid').style.color = "#ff5252";
            if(!document.getElementById('modLock').style.display || document.getElementById('modLock').style.display === 'none') {
                 setTimeout(() => document.getElementById('modLock').style.display='flex', 1000);
            }
        } else {
            tag.innerText = "GRATIS (" + diffDays + " d√≠as)"; tag.className = "group-tag pro";
            document.getElementById('modLock').style.display='none';
        }
    }

    function generateDynamicHash(group, month, year) { 
        let h=0; 
        const s = group + "_" + month + "_" + year + "_CYM_SECURE_2026"; 
        for(let i=0;i<s.length;i++) h=((h<<5)-h)+s.charCodeAt(i)|0; 
        return Math.abs(h).toString(36).toUpperCase().substring(0,6); 
    }

    function unlockPro() {
        const code = document.getElementById('unlockCode').value.trim().toUpperCase();
        if(code === "DEMO") { 
             extendValidity(new Date(new Date().setMonth(new Date().getMonth() + 1)));
             return;
        }

        const now = new Date();
        let foundMatch = false;
        
        for(let i=0; i<12; i++) {
            const checkDate = new Date(now.getFullYear(), now.getMonth() + i, 1);
            const m = checkDate.getMonth();
            const y = checkDate.getFullYear();
            
            const expected = generateDynamicHash(currentGroup, m, y);
            
            if(code === expected) {
                const lastDay = new Date(y, m + 1, 0); 
                extendValidity(lastDay);
                foundMatch = true;
                break;
            }
        }
        
        if(!foundMatch) alert("C√≥digo inv√°lido o expirado.");
    }

    function extendValidity(dateObj) {
        db.collection('groups').doc(currentGroup).update({ validUntil: dateObj.toISOString() }).then(() => {
            alert("¬°Pago exitoso! Vencimiento actualizado al: " + dateObj.toLocaleDateString());
            location.reload();
        });
    }

    // --- PANEL DE ADMINISTRADOR ---
    function savePrice() {
        if(currentUser.email !== ADMIN_EMAIL) return;
        const val = document.getElementById('adminPriceInput').value;
        if(val) {
            db.collection('config').doc('pricing').set({ val: parseInt(val) })
            .then(() => alert("Precio actualizado para todos los usuarios."));
        }
    }

    function renderAdmin() {
        if(currentUser.email !== ADMIN_EMAIL) return;
        
        const selY = document.getElementById('adminYear');
        if(selY.options.length < 2) {
            selY.innerHTML = "";
            const currentYear = new Date().getFullYear();
            for(let i=0; i<=5; i++) {
                const opt = document.createElement('option');
                opt.value = currentYear + i;
                opt.text = currentYear + i;
                selY.add(opt);
            }
        }

        document.getElementById('adminPriceInput').value = globalPrice;

        const selM = document.getElementById('adminMonth').value;
        const currentYVal = selY.value; 
        
        const listDiv = document.getElementById('adminList');
        listDiv.innerHTML = '<p style="text-align:center">Cargando grupos...</p>';
        
        let stats = { users:0, groups:0, active:0, expired:0 };

        db.collection('groups').get().then(snapshot => {
            let html = '<table class="admin-table"><thead><tr><th>Grupo / Miembros</th><th>Vencimiento</th><th>Clave ('+ (parseInt(selM)+1) + '/' + currentYVal +')</th></tr></thead><tbody>';
            
            snapshot.forEach(doc => {
                const g = doc.data();
                const vDate = new Date(g.validUntil || 0);
                const isVencido = vDate < new Date();
                
                stats.groups++;
                stats.users += (g.members ? g.members.length : 0);
                if(isVencido) stats.expired++; else stats.active++;

                const code = generateDynamicHash(doc.id, parseInt(selM), parseInt(currentYVal));
                
                let membersHtml = g.members.map(m => 
                    `<div>
                        ${m === g.owner ? '‚òÖ' : ''} ${m} 
                        ${m !== g.owner ? `<span class="del-user" onclick="kickUser('${doc.id}', '${m}')">[x]</span> <span class="del-user" onclick="alert('IMPOSIBLE: Para borrar la cuenta definitivamente, ve a Firebase Console > Authentication')">[‚ò†Ô∏è]</span>` : ''}
                    </div>`
                ).join('');
                membersHtml += `<div class="add-user" onclick="addUser('${doc.id}')">+ Usr</div>`;

                html += `<tr>
                    <td>
                        <strong style="color:#fff; font-size:1.1rem;">${doc.id}</strong><br>
                        <div style="margin-top:5px; font-size:0.75rem; line-height:1.4;">${membersHtml}</div>
                    </td>
                    <td>
                        <span class="tag-adm" onclick="modDate('${doc.id}', '${g.validUntil}')" style="background:${isVencido?'#ff5252':'#00e676'}; color:#000;">${vDate.toLocaleDateString()} ‚úèÔ∏è</span>
                        <div style="margin-top:5px;">
                            <button class="btn-s" style="padding:2px 5px; font-size:0.7rem; color:#ff5252; border-color:#ff5252;" onclick="deleteGroup('${doc.id}')">üóëÔ∏è</button>
                        </div>
                    </td>
                    <td>
                        <button class="btn-s" style="padding:10px; font-weight:bold; font-size:1rem; color:#BB86FC; border:1px solid #BB86FC;" onclick="prompt('Copia clave ${doc.id}:','${code}')">üîë ${code}</button>
                    </td>
                </tr>`;
            });
            html += '</tbody></table>';
            listDiv.innerHTML = html;

            document.getElementById('statUsers').innerText = stats.users;
            document.getElementById('statGroups').innerText = stats.groups;
            document.getElementById('statActive').innerText = stats.active;
            document.getElementById('statExpired').innerText = stats.expired;
        });
    }

    function modDate(id, current) {
        if(currentUser.email !== ADMIN_EMAIL) return;
        const newD = prompt("Ingresa nueva fecha (YYYY-MM-DD):", current ? current.split('T')[0] : '');
        if(newD) {
            const d = new Date(newD);
            if(!isNaN(d.getTime())) {
                db.collection('groups').doc(id).update({ validUntil: d.toISOString() }); // Ya no recarga manual, el listener lo hace
            } else alert("Fecha inv√°lida");
        }
    }

    function kickUser(groupId, email) {
        if(currentUser.email !== ADMIN_EMAIL) return;
        if(confirm(`¬øSacar a ${email} del grupo? (NO borra su cuenta)`)) {
            db.collection('groups').doc(groupId).update({
                members: firebase.firestore.FieldValue.arrayRemove(email)
            }).then(() => renderAdmin());
        }
    }

    function addUser(groupId) {
        if(currentUser.email !== ADMIN_EMAIL) return;
        const email = prompt("Email del nuevo usuario (Debe registrarse con Google):");
        if(email && email.includes('@')) {
            db.collection('groups').doc(groupId).update({
                members: firebase.firestore.FieldValue.arrayUnion(email.trim().toLowerCase())
            }).then(() => renderAdmin());
        }
    }

    function deleteGroup(id) {
        if(confirm("¬øESTAS SEGURO de borrar el grupo " + id + " y todos sus datos?")) {
            db.collection('groups').doc(id).delete();
            db.collection('data').doc(id).delete().then(() => {
                alert("Grupo eliminado");
                renderAdmin();
            });
        }
    }

    // --- RESTAURAR BACKUP ---
    function restoreBackup(input) {
        if(isExpired) return alert("Servicio vencido. Paga para importar datos.");
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = e => {
            try {
                const d = JSON.parse(e.target.result);
                let newExp = [], newPay = {}, newAcc = [];

                if(Array.isArray(d.expenses)) {
                    newExp = d.expenses.map(e => ({
                        id: e.id || Date.now(),
                        name: e.name || "Sin Nombre",
                        cat: e.cat || "Otros",
                        folder: e.folder || "",
                        link: e.link || "",
                        user: e.user || "",
                        pass: e.pass || "",
                        comment: e.comment || ""
                    }));
                }
                
                if(d.payments) {
                    Object.keys(d.payments).forEach(key => {
                        const oldP = d.payments[key];
                        newPay[key] = {
                            amt: oldP.amount || oldP.amt,
                            day: oldP.day,
                            paid: oldP.paid,
                            accId: oldP.accId
                        };
                    });
                }

                if(Array.isArray(d.accounts)) {
                    newAcc = d.accounts.map(a => ({
                        id: a.id || Date.now(),
                        name: a.name || "Cuenta",
                        bal: parseFloat(a.balance || a.bal || 0)
                    }));
                }

                if(confirm(`Importar: ${newExp.length} gastos y ${newAcc.length} cuentas?`)) {
                    appData = { expenses: newExp, payments: newPay, accounts: newAcc };
                    saveData();
                    alert("¬°Datos importados correctamente!");
                }
            } catch(err) { alert("Error archivo: " + err.message); }
        };
        reader.readAsText(file);
    }
    
    function downloadBackup() {
        const data = { ...appData, meta: { group: currentGroup, date: new Date() } };
        const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Backup_${currentGroup}.json`; a.click();
    }

    function saveData() { if(currentGroup) db.collection('data').doc(currentGroup).set(appData); }

    // --- FUNCIONES DE BORRADO MASIVO ---
    function nukeExpenses() {
        if(checkLock()) return;
        if(confirm("‚ö†Ô∏è ¬øEST√ÅS SEGURO? Se borrar√°n TODOS los gastos y su historial de pagos. No se puede deshacer.")) {
            if(confirm("Confirmaci√≥n final: ¬øBorrar TODO?")) {
                appData.expenses = [];
                appData.payments = {}; 
                saveData();
                alert("Gastos eliminados.");
            }
        }
    }

    function nukeAccounts() {
        if(checkLock()) return;
        if(confirm("‚ö†Ô∏è ¬øEST√ÅS SEGURO? Se borrar√°n TODAS las cuentas bancarias.")) {
            appData.accounts = [];
            saveData();
            alert("Cuentas eliminadas.");
        }
    }

    // --- RENDERIZADO UI ---
    function renderAll() { renderGrid(); renderAcc(); calcDash(); }
    
    function renderGrid() {
        const t = document.getElementById('mainTable');
        t.innerHTML = `<thead><tr>
            <th class="col-fix" onclick="sortByMonth(-1)">Concepto (Ordenar)</th>
            ${[...Array(12)].map((_,i)=>`<th onclick="sortByMonth(${i})">${new Date(year,i,1).toLocaleDateString('es-ES',{month:'short'}).toUpperCase()}</th>`).join('')}
        </tr></thead>`;
        
        let body = '<tbody>';
        appData.expenses.forEach(e => {
            body += `<tr><td class="col-fix"><span class="expense-name">${e.name}</span><div style="font-size:0.7rem;color:#aaa">${e.cat}</div>
            <div style="margin-top:2px;">
                ${e.folder ? `<span class="icon-btn" onclick="window.open('${e.folder}')">üìÅ</span>` : ''}
                ${e.link ? `<span class="icon-btn" onclick="window.open('${e.link}')">üîó</span>` : ''}
                ${e.user||e.pass ? `<span class="icon-btn" onclick="alert('U: ${e.user}\\nP: ${e.pass}')">üîë</span>` : ''}
                ${e.comment ? `<span class="icon-btn" onclick="alert('${e.comment}')">üí¨</span>` : ''}
                <span class="icon-btn" onclick="editExp(${e.id})">‚úèÔ∏è</span>
            </div></td>`;
            for(let i=0; i<12; i++) {
                const k = `${e.id}_${year}_${i}`; const p = appData.payments[k] || {};
                const st = p.paid ? 'status-paid' : (p.amt ? 'status-pend' : '');
                const dayText = (p.day !== undefined && p.day !== '') ? 'D√≠a ' + p.day : '';
                body += `<td class="${st}"><div onclick="openCell(${e.id},${i})" style="height:100%;display:flex;flex-direction:column;justify-content:center;align-items:center;cursor:pointer;">${p.amt ? '$'+parseInt(p.amt).toLocaleString() : ''}<span style="font-size:0.8rem; font-weight:bold; color:#aaa;">${dayText}</span></div></td>`;
            }
            body += '</tr>';
        });
        t.innerHTML += body + '</tbody>';
    }

    // FUNCION DE ORDENAMIENTO
    function sortByMonth(monthIndex) {
        if(monthIndex === -1) {
            // Ordenar por nombre
            appData.expenses.sort((a,b) => a.name.localeCompare(b.name));
        } else {
            // Ordenar por dia de vencimiento en ese mes
            appData.expenses.sort((a,b) => {
                const kA = `${a.id}_${year}_${monthIndex}`;
                const kB = `${b.id}_${year}_${monthIndex}`;
                const pA = appData.payments[kA] || {};
                const pB = appData.payments[kB] || {};
                
                // Si no tiene dia, lo mandamos al fondo (Infinity)
                const dayA = (pA.day !== undefined && pA.day !== '') ? parseInt(pA.day) : 999;
                const dayB = (pB.day !== undefined && pB.day !== '') ? parseInt(pB.day) : 999;
                
                if(dayA === dayB) return a.name.localeCompare(b.name);
                return dayA - dayB;
            });
        }
        renderGrid();
    }

    function renderAcc() {
        const l = document.getElementById('accList'); l.innerHTML = '';
        const s = document.getElementById('mcAcc'); s.innerHTML = '<option value="">--</option>';
        const now = new Date();
        
        appData.accounts.forEach(a => {
            let assignedHTML = '';
            let pendingSum = 0;
            
            appData.expenses.forEach(e => {
                const k = `${e.id}_${now.getFullYear()}_${now.getMonth()}`;
                const p = appData.payments[k];
                if(p && p.accId == a.id && !p.paid && p.amt) {
                    pendingSum += parseFloat(p.amt);
                    assignedHTML += `<div class="det-row"><span>${e.name}</span><span style="color:#ff5252">-$${parseInt(p.amt).toLocaleString()}</span></div>`;
                }
            });
            
            const projected = (parseFloat(a.bal)||0) - pendingSum;
            s.innerHTML += `<option value="${a.id}">${a.name}</option>`;
            
            l.innerHTML += `
            <div class="acc-card">
                <div class="acc-head" onclick="toggleAcc(${a.id})">
                    <div><b>${a.name}</b><br><span style="font-size:0.8rem;color:#BB86FC">Proyectado: $${projected.toLocaleString()}</span></div>
                    <div style="text-align:right">
                        <div style="color:#00e676; font-weight:bold; font-size:1.1rem;">$${parseFloat(a.bal).toLocaleString()}</div>
                        <div style="margin-top:5px;"><span class="icon-btn" onclick="editAcc(${a.id}); event.stopPropagation()">‚úèÔ∏è</span> <span class="icon-btn" style="color:red" onclick="delAcc(${a.id}); event.stopPropagation()">‚úñ</span></div>
                    </div>
                </div>
                <div id="accDet-${a.id}" class="acc-detail">
                    <div class="det-row"><span>Saldo Real</span><span style="color:#fff">$${parseFloat(a.bal).toLocaleString()}</span></div>
                    ${assignedHTML || '<div style="text-align:center;color:#555;font-style:italic;padding:5px;">Sin gastos asignados pendientes</div>'}
                    <div class="det-total"><div style="display:flex;justify-content:space-between"><span>FINAL PROYECTADO</span><span>$${projected.toLocaleString()}</span></div></div>
                </div>
            </div>`;
        });
    }
    
    function toggleAcc(id) { const el = document.getElementById(`accDet-${id}`); el.classList.toggle('open'); }

    function calcDash() {
        let debt=0, assets=0;
        const now = new Date();
        appData.expenses.forEach(e => {
            const k = `${e.id}_${now.getFullYear()}_${now.getMonth()}`;
            const p = appData.payments[k];
            if(p && p.amt && !p.paid) debt += parseInt(p.amt);
        });
        appData.accounts.forEach(a => assets += parseFloat(a.bal));
        document.getElementById('dTotal').innerText = '$'+assets.toLocaleString();
        document.getElementById('dDebt').innerText = '$'+debt.toLocaleString();
        document.getElementById('dNet').innerText = '$'+(assets-debt).toLocaleString();
    }

    // --- CRUD ---
    let edId=null;
    function openModalExp() { if(checkLock()) return; edId=null; cleanExp(); document.getElementById('modExp').style.display='flex'; }
    function editExp(id) { if(checkLock()) return; edId=id; const e=appData.expenses.find(x=>x.id==id); loadExp(e); document.getElementById('modExp').style.display='flex'; }
    function saveExp() {
        const obj = { name: val('meName'), cat: val('meCat'), folder: val('meFolder'), link: val('meLink'), user: val('meUser'), pass: val('mePass'), comment: val('meComm') };
        if(edId) { const idx=appData.expenses.findIndex(x=>x.id==edId); appData.expenses[idx]={...appData.expenses[idx], ...obj}; }
        else appData.expenses.push({id:Date.now(), ...obj});
        saveData(); closeModal('modExp');
    }
    
    // NUEVA FUNCION BORRAR GASTO Y SUS PAGOS
    function delExp() {
        if(checkLock()) return;
        if(!edId) return;
        if(confirm("¬øBorrar este gasto y TODO su historial de pagos?")) {
            // 1. Borrar de la lista de gastos
            appData.expenses = appData.expenses.filter(x => x.id !== edId);
            
            // 2. Borrar pagos asociados en el diccionario (claves empiezan con ID_)
            Object.keys(appData.payments).forEach(key => {
                if(key.startsWith(edId + "_")) {
                    delete appData.payments[key];
                }
            });
            
            saveData();
            closeModal('modExp');
        }
    }
    
    let acId=null;
    function openModalAcc() { if(checkLock()) return; acId=null; document.getElementById('maName').value=''; document.getElementById('maBal').value=''; document.getElementById('modAcc').style.display='flex'; }
    function editAcc(id) { if(checkLock()) return; acId=id; const a=appData.accounts.find(x=>x.id==id); document.getElementById('maName').value=a.name; document.getElementById('maBal').value=a.bal; document.getElementById('modAcc').style.display='flex'; }
    function saveAcc() {
        const n=val('maName'); 
        // SMART PARSE PARA CUENTAS
        const b=smartParse(val('maBal'));
        if(acId) { const a=appData.accounts.find(x=>x.id==acId); a.name=n; a.bal=b; }
        else appData.accounts.push({id:Date.now(), name:n, bal:b});
        saveData(); closeModal('modAcc');
    }
    function delAcc(id) { if(checkLock()) return; if(confirm("¬øBorrar?")) { appData.accounts=appData.accounts.filter(a=>a.id!=id); saveData(); } }

    function openCell(eid, m) {
        if(checkLock()) return;
        selCell = {eid, m}; const k = `${eid}_${year}_${m}`; const p = appData.payments[k] || {};
        document.getElementById('mcAmt').value = p.amt||'';
        document.getElementById('mcDay').value = p.day||'';
        document.getElementById('mcAcc').value = p.accId||'';
        document.getElementById('mcPaid').checked = p.paid||false;
        document.getElementById('modCell').style.display='flex';
    }
    function saveCell() {
        const k = `${selCell.eid}_${year}_${selCell.m}`;
        // SMART PARSE PARA PAGOS
        const rawAmt = val('mcAmt');
        const amt = smartParse(rawAmt);
        const day = val('mcDay');
        const paid = document.getElementById('mcPaid').checked;
        
        // LOGICA CORREGIDA: Guardar si hay importe, O dia, O pagado.
        if(amt || day || paid) {
            appData.payments[k] = { amt, day, accId: val('mcAcc'), paid };
        } else {
            delete appData.payments[k];
        }
        saveData(); closeModal('modCell');
    }
    function delCell() { delete appData.payments[`${selCell.eid}_${year}_${selCell.m}`]; saveData(); closeModal('modCell'); }

    // UTILS
    function checkLock() { if(isExpired) { document.getElementById('modLock').style.display='flex'; return true; } return false; }
    function val(id) { return document.getElementById(id).value; }
    function cleanExp() { ['meName','meFolder','meLink','meUser','mePass','meComm'].forEach(i=>document.getElementById(i).value=''); }
    function loadExp(e) { document.getElementById('meName').value=e.name; document.getElementById('meFolder').value=e.folder||''; document.getElementById('meLink').value=e.link||''; document.getElementById('meUser').value=e.user||''; document.getElementById('mePass').value=e.pass||''; document.getElementById('meComm').value=e.comment||''; document.getElementById('meCat').value=e.cat; }
    
    function switchTab(t) { 
        document.querySelectorAll('.view').forEach(v=>v.classList.remove('active')); 
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); 
        
        if(t === 'admin') {
            document.getElementById('view-admin').classList.add('active');
            renderAdmin(); 
        } else {
            document.getElementById('view-'+t).classList.add('active'); 
        }
        
        const tabEl = document.querySelector(`.tab[onclick="switchTab('${t}')"]`);
        if(tabEl) tabEl.classList.add('active');
        
        if(t==='planilla') renderAll(); 
    }
    
    function changeYear(d) { year+=d; document.getElementById('dispYear').innerText=year; renderAll(); }
    function closeModal(id) { document.getElementById(id).style.display='none'; }
    function exportExcel() { const ws=XLSX.utils.table_to_sheet(document.getElementById('mainTable')); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Pagos"); XLSX.writeFile(wb,"Pagos.xlsx"); }
</script>
</body>
</html>