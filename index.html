<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Armado de Pagos</title>
    
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <style>
        /* VARIABLE CSS PARA ANCHO COLUMNA */
        :root { --col-w: 150px; }

        /* ESTILOS (Dark Theme) */
        body { font-family: 'Segoe UI', Roboto, sans-serif; background-color: #121212; color: #eee; margin: 0; padding-bottom: 0; display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden; transition: 0.3s; }
        a { text-decoration: none; color: inherit; }

        /* MODO ZEN (PANTALLA COMPLETA) */
        body.zen-mode .app-header, 
        body.zen-mode .tabs, 
        body.zen-mode .footer, 
        body.zen-mode .dashboard-grid { display: none !important; }
        body.zen-mode .view { height: 100vh; padding-top: 10px; }

        /* SCROLLBAR PERSONALIZADO */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1e1e1e; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }

        /* HEADER */
        .app-header { width: 100%; background: #1e1e1e; padding: 10px 15px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; box-sizing: border-box; flex-shrink: 0; }
        .logo-area { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .logo-img { height: 40px; border-radius: 8px; border: 1px solid #444; }
        .app-info { display:flex; flex-direction:column; }
        .app-name { font-weight: 800; font-size: 0.95rem; color: #fff; line-height:1.1; }
        .app-sub { font-size: 0.7rem; color: #BB86FC; font-weight: bold; letter-spacing: 1px; }
        
        .user-badge { text-align: right; }
        .user-email { color: #ccc; font-size: 0.75rem; }
        .group-tag { background: #333; color: #ccc; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: bold; display: inline-block; margin-top: 2px; border: 1px solid #555; }
        .group-tag.pro { background: linear-gradient(45deg, #00e676, #00c853); color: #000; border: none; box-shadow: 0 0 10px rgba(0,230,118,0.3); }
        .group-tag.expired { background: #ff5252; color: #fff; border: none; }

        /* PANTALLAS */
        #authScreen, #groupScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #050505; z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .auth-box { background: #1e1e1e; padding: 30px; border-radius: 15px; border: 1px solid #333; width: 90%; max-width: 350px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .auth-btn { width: 100%; padding: 12px; margin-top: 10px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-google { background: #fff; color: #333; display: flex; align-items: center; justify-content: center; gap: 10px; font-family: Roboto, sans-serif; }
        
        .pass-wrapper { position: relative; width: 100%; }
        .pass-toggle { position: absolute; right: 15px; top: 15px; cursor: pointer; color: #aaa; font-size: 1.2rem; }

        /* UI GENERAL */
        .tabs { display: flex; width: 98%; max-width: 1400px; margin: 5px auto; background: #252525; border-radius: 10px; border: 1px solid #333; overflow: hidden; flex-shrink: 0; }
        .tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; color: #888; font-weight: 600; font-size: 0.9rem; }
        .tab.active { background: #BB86FC; color: #000; font-weight: 800; }
        #tab-admin { display: none; background: #330000; color: #ff5252; } 
        
        .view { display: none; width: 98%; max-width: 1400px; margin: 0 auto; flex-direction: column; gap: 5px; height: 100%; overflow: hidden; }
        .view.active { display: flex; }

        .dashboard-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-bottom: 5px; flex-shrink: 0; }
        .dash-card { background: #1e1e1e; padding: 8px; border-radius: 8px; border: 1px solid #333; text-align: center; }
        .dash-val { font-size: 0.9rem; font-weight: bold; font-family: monospace; margin-top:2px; }
        .c-g { color: #00e676; } .c-r { color: #ff5252; } .c-p { color: #BB86FC; }

        /* FILTROS Y TOOLBAR */
        .filter-row { display: flex; gap: 8px; overflow-x: auto; padding: 5px 0; align-items: center; width: 100%; flex-shrink: 0; scrollbar-width: none; }
        .filter-row::-webkit-scrollbar { display: none; }
        .filter-pill { background: #252525; padding: 5px 12px; border-radius: 15px; color: #ccc; white-space: nowrap; cursor: pointer; border: 1px solid #444; display:flex; align-items:center; gap:5px; font-size:0.75rem; transition: 0.2s; }
        .filter-pill.active { background: #BB86FC; color: #000; border-color: #BB86FC; font-weight: bold; }
        
        .toolbar-right { margin-left: auto; display: flex; gap: 8px; flex-shrink: 0; }
        .filter-icon { min-width: 35px; width: 35px; height: 35px; border-radius: 50%; background: #222; border: 1px solid #555; display: flex; justify-content: center; align-items: center; cursor: pointer; color: #aaa; font-size: 1rem; }
        .filter-icon:hover { color: #fff; border-color: #BB86FC; color: #BB86FC; }

        /* TABLA SCROLLABLE */
        .grid-con { 
            overflow: auto; 
            background: #1e1e1e; 
            border-radius: 8px 8px 0 0; 
            border: 1px solid #333; 
            flex: 1; 
            position: relative;
            padding-bottom: 100px; 
        }
        
        table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 900px; }
        
        th { 
            background: #252525; position: sticky; top: 0; padding: 8px; color: #aaa; 
            border-bottom: 2px solid #444; z-index: 20; cursor: pointer; user-select: none; font-size: 0.85rem; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        td { border-bottom: 1px solid #333; border-right: 1px solid #333; height: 45px; padding: 0; vertical-align: middle; }
        
        /* COLUMNA FIJA REGULABLE */
        .col-fix { 
            position: sticky; left: 0; background: #1e1e1e; border-right: 2px solid #444 !important; 
            z-index: 10; 
            min-width: var(--col-w); max-width: var(--col-w); /* USA LA VARIABLE */
            padding: 5px; 
            transition: 0.1s;
        }
        th.col-fix { z-index: 30; }
        
        /* FILA DE TOTALES */
        .row-total td { background: #2a2a2a; color: #BB86FC; font-weight: bold; border-top: 2px solid #555; font-size: 0.9rem; text-align: right; padding-right: 15px; }
        .row-total .col-fix { background: #2a2a2a; color: #BB86FC; z-index: 15; text-align: left; }

        /* DISE√ëO CELDA SPLIT */
        .cell-container { display: flex; height: 100%; width: 100%; cursor: pointer; }
        .cell-day { width: 25px; background: #151515; border-right: 1px solid #333; display: flex; align-items: center; justify-content: center; font-size: 0.85rem; font-weight: 800; color: #fff; }
        .cell-data { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; }
        .cell-amt { font-size: 0.8rem; font-weight: bold; color: #fff; }
        .acc-dot { position: absolute; top: 3px; right: 3px; width: 6px; height: 6px; border-radius: 50%; }

        /* OTRAS VISTAS */
        #view-cuentas, #view-help, #view-config, #view-admin { overflow-y: auto; padding-bottom: 80px; }

        /* ADMIN & UI */
        .admin-controls { display:flex; gap:10px; justify-content:center; margin-bottom:10px; background:#2a2a2a; padding:10px; border-radius:8px; }
        .admin-table { width: 100%; min-width: 300px; border-collapse: collapse; }
        .admin-table th { text-align: left; color: #BB86FC; padding: 8px; border-bottom: 2px solid #444; }
        .admin-table td { padding: 8px; border-bottom: 1px solid #333; font-size: 0.85rem; vertical-align: top; }
        .tag-adm { padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; white-space: nowrap; cursor: pointer;}
        .del-user { color: #ff5252; cursor: pointer; font-weight: bold; margin-left: 5px; }
        .add-user { color: #00e676; cursor: pointer; font-size: 0.8rem; border: 1px solid #00e676; padding: 2px 5px; border-radius: 5px; display:inline-block; margin-top:5px; }

        /* FOOTER FLOTANTE */
        .footer { position: fixed; bottom: 0; width: 100%; background: rgba(26,26,26,0.95); backdrop-filter: blur(5px); padding: 8px 15px; border-top: 1px solid #333; text-align: center; z-index: 50; display:flex; flex-direction:column; gap:5px; align-items:center; }
        .cafe-row { display: flex; gap: 10px; justify-content: center; width: 100%; max-width: 400px; }
        
        .btn { padding: 10px; width: 100%; border-radius: 5px; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-p { background: #BB86FC; color: #000; }
        .btn-s { background: #333; color: #ccc; border: 1px solid #555; }
        .btn-d { background: #330000; color: #ff5252; border: 1px solid #ff5252; }
        .btn-tool { background: transparent; border: 1px solid #555; color: #aaa; padding: 8px; font-size: 0.8rem; border-radius: 5px; cursor: pointer; flex: 1; }
        
        input, select { width: 100%; padding: 12px; margin: 5px 0 15px 0; background: #151515; border: 1px solid #444; color: #fff; border-radius: 5px; box-sizing: border-box; }
        
        /* BOTON FLOTANTE MOVIBLE */
        .fab { position: fixed; bottom: 30px; right: 20px; width: 55px; height: 55px; border-radius: 50%; background: #BB86FC; color: #000; font-size: 2rem; border: none; cursor: pointer; display: flex; justify-content: center; align-items: center; z-index: 60; box-shadow: 0 4px 10px rgba(0,0,0,0.5); touch-action: none; user-select: none; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; justify-content: center; align-items: center; }
        .modal-box { background: #252525; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; border: 1px solid #555; max-height: 90vh; overflow-y: auto; }

        /* ESTADOS DE PAGO */
        .status-paid { background: rgba(0, 230, 118, 0.15) !important; border-left: 3px solid #00e676; }
        .status-pend { background: rgba(255, 82, 82, 0.15); border-left: 3px solid #ff5252; } 
        .status-soon { background: rgba(255, 234, 0, 0.15); border-left: 3px solid #ffea00; }
        
        .expense-name { font-weight:bold; font-size:0.85rem; display:block; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        .icon-btn { cursor:pointer; margin-left:5px; opacity:0.7; } .icon-btn:hover { opacity:1; }
        .price-display { color: #00e676; font-weight: bold; font-size: 1.1rem; text-align: center; margin-bottom: 10px; }
        
        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-bottom: 10px; }
        .stat-box { background: #2a2a2a; padding: 8px; border-radius: 8px; text-align: center; border: 1px solid #444; }
        .stat-num { font-size: 1.1rem; font-weight: bold; color: #fff; }
        .stat-label { font-size: 0.6rem; color: #aaa; text-transform: uppercase; }
        .cat-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #333; align-items: center; }
        
        /* ACORDEON CUENTAS */
        .acc-card { background: #1e1e1e; border-radius: 10px; border: 1px solid #333; margin-bottom: 10px; overflow: hidden; }
        .acc-head { display: flex; justify-content: space-between; align-items: center; padding: 15px; cursor: pointer; }
        .acc-detail { display: none; background: #151515; padding: 15px; border-top: 1px solid #333; }
        .acc-detail.open { display: block; animation: fadeIn 0.3s; }
    </style>
</head>
<body>

    <div id="authScreen">
        <div class="auth-box">
            <a href="https://www.cymaplicaciones.com">
                <img src="logo.jpg" style="height:70px; border-radius:10px; margin-bottom:15px; border:1px solid #444;">
            </a>
            <h2 style="color:#BB86FC; margin:0;">Armado de Pagos</h2>
            <p style="color:#aaa; font-size:0.9rem;">Accede a tu panel de control</p>
            <input type="email" id="email" placeholder="Correo electr√≥nico">
            <div class="pass-wrapper">
                <input type="password" id="password" placeholder="Contrase√±a">
                <span class="pass-toggle" onclick="togglePass()">üëÅÔ∏è</span>
            </div>
            <div style="text-align:right; margin-bottom:15px;">
                <span onclick="resetPass()" style="font-size:0.75rem; color:#BB86FC; cursor:pointer; text-decoration:underline;">¬øOlvidaste tu contrase√±a?</span>
            </div>
            <button class="auth-btn btn-p" onclick="loginEmail()">Iniciar Sesi√≥n</button>
            <button class="auth-btn btn-s" onclick="registerEmail()">Crear Cuenta</button>
            <div style="margin:20px 0; border-top:1px solid #333; padding-top:15px; color:#555; font-size:0.8rem;">O CONTINUA CON</div>
            <button class="auth-btn btn-google" onclick="loginGoogle()">
                <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" width="20"> 
                <span style="font-weight:500;">Acceder con Google</span>
            </button>
            <p id="authMsg" style="color:#ff5252; margin-top:10px; font-size:0.9rem;"></p>
        </div>
    </div>

    <div id="groupScreen" style="display:none;">
        <div class="auth-box">
            <a href="https://www.cymaplicaciones.com">
                <img src="logo.jpg" style="height:50px; border-radius:10px; margin-bottom:10px;">
            </a>
            <h2 style="color:#BB86FC;">Seleccionar Grupo</h2>
            <p style="color:#aaa;">Ingresa el nombre de tu grupo/familia</p>
            <input type="text" id="groupNameInput" placeholder="Ej: FLIA_PEREZ" style="text-transform:uppercase; text-align:center; font-size:1.2rem; letter-spacing:1px;">
            <div id="pinArea" style="display:none; background:#2a2a2a; padding:15px; border-radius:8px; margin-bottom:15px; border:1px solid #444;">
                <p style="margin:0 0 5px 0; font-size:0.9rem; color:#ffb74d;">üîí Grupo Privado</p>
                <input type="text" id="groupPinInput" placeholder="PIN" style="text-align:center; letter-spacing:5px; font-size:1.5rem; width:100px; margin:0 auto;">
            </div>
            <button class="auth-btn btn-p" onclick="checkGroup()">ENTRAR</button>
            <button class="auth-btn btn-s" style="margin-top:20px;" onclick="logout()">Cerrar Sesi√≥n</button>
            <p id="groupMsg" style="color:#ff5252; margin-top:10px; font-size:0.9rem;"></p>
        </div>
    </div>

    <div class="app-header">
        <a href="https://www.cymaplicaciones.com" class="logo-area">
            <img src="logo.jpg" class="logo-img" alt="Logo">
            <div class="app-info">
                <span class="app-name">Armado de Pagos</span>
                <span class="app-sub" id="headerGroupName">...</span>
            </div>
        </a>
        <div class="user-badge">
            <div class="user-email" id="dispUserEmail">...</div>
            <div class="group-tag" id="dispGroupTag">GRATIS</div>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('planilla')">üìù Planilla</div>
        <div class="tab" onclick="switchTab('cuentas')">üí≥ Cuentas</div>
        <div class="tab" onclick="switchTab('help')">‚ùì Ayuda</div>
        <div class="tab" onclick="switchTab('config')">‚öôÔ∏è Config</div>
        <div class="tab" id="tab-admin" onclick="switchTab('admin')">üîí Admin</div>
    </div>

    <div id="view-planilla" class="view active">
        <div class="dashboard-grid">
            <div class="dash-card"><div class="dash-val c-g" id="dTotal">$0</div><div style="font-size:0.7rem; color:#aaa">FONDOS</div></div>
            <div class="dash-card"><div class="dash-val c-r" id="dDebt">$0</div><div style="font-size:0.7rem; color:#aaa">DEUDA</div></div>
            <div class="dash-card"><div class="dash-val c-p" id="dNet">$0</div><div style="font-size:0.7rem; color:#aaa">NETO</div></div>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center; background:#252525; padding:5px 15px; border-radius:8px; margin-bottom:10px; flex-shrink:0;">
            <button class="btn-s" style="width:auto; margin:0" onclick="changeYear(-1)">&lt;</button>
            <span style="font-weight:bold;" id="dispYear">2026</span>
            <button class="btn-s" style="width:auto; margin:0" onclick="changeYear(1)">&gt;</button>
        </div>

        <div class="filter-row">
            <div class="filter-pill active" id="filt-ALL" onclick="setFilter('ALL')">Todos</div>
            <div id="filterList" style="display:flex; gap:10px;"></div>
            <div class="toolbar-right">
                <div class="filter-icon" onclick="exportExcel()">üì•</div>
                <div class="filter-icon" onclick="toggleZen()">‚õ∂</div>
                <div class="filter-icon" onclick="openModalCats()">‚öôÔ∏è</div>
            </div>
        </div>

        <div class="grid-con">
            <table id="mainTable"></table>
        </div>
    </div>

    <div id="view-cuentas" class="view">
        <button class="btn btn-p" onclick="openModalAcc()">+ Nueva Cuenta</button>
        <div id="accList" style="margin-top:15px;"></div>
    </div>

    <div id="view-help" class="view">
        <div class="dash-card" style="text-align:left;">
            <h3 style="color:#BB86FC;">üìñ Manual de Uso</h3>
            <p><strong>1. Carga tu Dinero:</strong> Ve a la pesta√±a "Cuentas" y carga tus saldos reales (Banco, Efectivo).</p>
            <p><strong>2. Define tus Gastos:</strong> Usa el bot√≥n (+) para crear tus gastos fijos.</p>
            <p><strong>3. Categor√≠as:</strong> Usa el engranaje ‚öôÔ∏è para crear categor√≠as propias.</p>
            <hr style="border-color:#333; margin:20px 0;">
            <h3 style="color:#00e676;">üëë Plan PRO (<span class="uiPriceDisplay">$...</span>/mes)</h3>
            <p>Todos los grupos nuevos tienen <strong>30 d√≠as de prueba gratuita</strong>.</p>
            <p><strong>¬øC√≥mo renovar?</strong></p>
            <ol>
                <li>Al finalizar el periodo, realiza el pago del mes.</li>
                <li>Env√≠a el comprobante por WhatsApp.</li>
                <li>Recibir√°s una <strong>Clave Mensual</strong>.</li>
                <li>Ingresa la clave en "Configuraci√≥n".</li>
            </ol>
        </div>
        
        <div style="margin-top:20px; text-align:center;">
            <div class="cafe-row">
                <a href="https://link.mercadopago.com.ar/cafecitocym" target="_blank" style="flex:2; background:linear-gradient(45deg, #009EE3, #00B1EA); color:#fff; padding:10px; border-radius:20px; text-decoration:none; font-weight:bold; font-size:0.9rem;">‚òï Invitar Cafecito</a>
                <a href="https://wa.me/5492615734341?text=Hola!%20Te%20acabo%20de%20invitar%20un%20cafecito%20en%20la%20App" target="_blank" style="flex:1; background:#25D366; color:#fff; padding:10px; border-radius:20px; text-decoration:none; font-weight:bold; font-size:0.9rem;">üîî Avisar</a>
            </div>
            <div style="font-size:0.7rem; color:#666; font-style:italic; margin-top:5px;">Ayudame a seguir desarrollando aplicaciones como esta ‚ú®</div>
        </div>
    </div>

    <div id="view-config" class="view">
        <div class="dash-card" style="text-align:left; margin-bottom:15px; border-color:#00e676;">
            <h3 style="color:#00e676; margin-top:0;">‚ôªÔ∏è Migraci√≥n de Datos</h3>
            <div style="display:flex; gap:10px;">
                <button class="btn-tool" onclick="downloadBackup()">üíæ Crear Backup</button>
                <button class="btn-tool" onclick="document.getElementById('restInput').click()">üìÇ Restaurar Backup</button>
                <input type="file" id="restInput" style="display:none" onchange="restoreBackup(this)">
            </div>
        </div>
        
        <div class="dash-card" style="text-align:left; border-color:#BB86FC; margin-bottom:15px;">
            <p><b style="color:#BB86FC">Visualizaci√≥n</b></p>
            <label>Ancho Columna Concepto:</label>
            <input type="range" min="100" max="300" value="150" oninput="setColWidth(this.value)">
        </div>

        <div class="dash-card" style="text-align:left; border-color:#ff5252;">
            <h3 style="color:#ff5252; margin-top:0;">‚ò†Ô∏è Zona de Peligro</h3>
            <button class="btn btn-d" onclick="nukeExpenses()">üóëÔ∏è Borrar TODOS los Gastos</button>
            <button class="btn btn-d" onclick="nukeAccounts()">üóëÔ∏è Borrar TODAS las Cuentas</button>
        </div>
        
        <div class="dash-card" style="text-align:left; margin-top:15px;">
            <h3 style="color:#BB86FC">Mi Grupo</h3>
            <p>Nombre: <strong id="confGName" style="color:#fff">...</strong></p>
            <p>Vencimiento: <strong id="confValid" style="color:#fff">...</strong></p>
            <div style="background:#2a2a2a; padding:15px; border-radius:10px; text-align:center; border:1px dashed #555; margin:20px 0;">
                <p style="margin:0; color:#aaa; font-size:0.75rem; text-transform:uppercase;">PIN DE INVITACI√ìN</p>
                <div id="confPin" style="font-size:2.5rem; font-weight:bold; color:#00e676; letter-spacing:5px; margin:5px 0;">****</div>
                <p style="margin:0; font-size:0.8rem; color:#777;">Comparte este PIN.</p>
            </div>
            <div style="margin-top:15px; padding-top:15px; border-top:1px solid #333;">
                <p style="font-size:0.85rem; color:#aaa;">Pagar Suscripci√≥n / Canjear:</p>
                <div class="price-display">Valor Mensual: <span class="uiPriceDisplay">$...</span></div>
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <a href="https://link.mercadopago.com.ar/cafecitocym" target="_blank" class="btn btn-p" style="margin:0; text-align:center; background:#009EE3; color:white;">Pagar con MP</a>
                    <a href="https://wa.me/5492615734341?text=Hola!%20Ya%20hice%20el%20pago%20de%20mi%20grupo,%20envio%20comprobante." target="_blank" class="btn btn-s" style="margin:0; text-align:center; background:#25D366; color:white; border:none;">Enviar Comprobante</a>
                </div>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="unlockCode" placeholder="INGRESAR C√ìDIGO MES/A√ëO" style="margin:0; text-align:center;">
                    <button class="btn-p" style="margin:0; width:auto;" onclick="unlockPro()">OK</button>
                </div>
            </div>
            <hr style="border-color:#333; margin:20px 0;">
            <button class="btn btn-s" onclick="location.reload()">Cambiar de Grupo</button>
            <button class="btn btn-s" style="border-color:#ff5252; color:#ff5252" onclick="logout()">Cerrar Sesi√≥n</button>
        </div>
    </div>

    <div id="view-admin" class="view">
        <h2 style="color:#ff5252; text-align:center;">PANEL ADMINISTRADOR</h2>
        <div class="stats-grid" id="adminStats">
            <div class="stat-box"><div class="stat-num" id="statUsers">0</div><div class="stat-label">Usuarios</div></div>
            <div class="stat-box"><div class="stat-num" id="statGroups">0</div><div class="stat-label">Grupos</div></div>
            <div class="stat-box" style="border-color:#00e676;"><div class="stat-num" style="color:#00e676;" id="statActive">0</div><div class="stat-label">Activos</div></div>
            <div class="stat-box" style="border-color:#ff5252;"><div class="stat-num" style="color:#ff5252;" id="statExpired">0</div><div class="stat-label">Vencidos</div></div>
        </div>
        <div class="dash-card" style="text-align:left; border-color:#BB86FC; margin-bottom:15px;">
            <p><b style="color:#BB86FC">Configuraci√≥n Global</b></p>
            <label>Precio Suscripci√≥n:</label>
            <div style="display:flex; gap:5px;">
                <input type="number" id="adminPriceInput" placeholder="Ej: 6000">
                <button class="btn-p" style="width:auto; margin:0;" onclick="savePrice()">Guardar</button>
            </div>
        </div>
        <div class="dash-card" style="text-align:left;">
            <p><b>Generador de Claves Mensuales</b></p>
            <div class="admin-controls">
                <select id="adminMonth">
                    <option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option>
                    <option value="3">Abril</option><option value="4">Mayo</option><option value="5">Junio</option>
                    <option value="6">Julio</option><option value="7">Agosto</option><option value="8">Septiembre</option>
                    <option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option>
                </select>
                <select id="adminYear"></select> 
            </div>
            <p style="font-size:0.8rem; color:#aaa;">Selecciona Mes/A√±o y toca "üîë Clave" en el usuario.</p>
            <button class="btn btn-s" onclick="renderAdmin()">üîÑ Actualizar Lista</button>
        </div>
        <div id="adminList"></div>
    </div>

    <button class="fab" id="fabBtn">+</button>

    <div id="modExp" class="modal">
        <div class="modal-box">
            <h3>Gasto / Servicio</h3>
            <label>Nombre:</label>
            <input id="meName" placeholder="Ej: Luz Casa">
            <label>Categor√≠a:</label>
            <div style="display:flex; gap:5px;">
                <select id="meCat" style="flex:1"></select>
                <button class="btn-s" style="width:auto; margin:5px 0 15px 0;" onclick="openModalCats()">‚öôÔ∏è</button>
            </div>
            <label>Link Carpeta Comprobantes:</label>
            <input id="meFolder" placeholder="https://drive.google.com...">
            <label>Link de Pago (Web):</label>
            <input id="meLink" placeholder="https://...">
            <div style="background:#333; padding:10px; border-radius:5px; margin-bottom:10px;">
                <label style="color:#BB86FC; font-size:0.8rem;">Credenciales (Opcional):</label>
                <input id="meUser" placeholder="Usuario / ID" style="margin-bottom:5px;">
                <input id="mePass" placeholder="Contrase√±a">
            </div>
            <label>Comentarios:</label>
            <input id="meComm" placeholder="...">
            <button class="btn btn-p" onclick="saveExp()">Guardar</button>
            <button class="btn btn-s" onclick="closeModal('modExp')">Cancelar</button>
            <button class="btn btn-d" style="margin-top:15px;" onclick="delExp()">üóëÔ∏è Borrar Gasto y Pagos</button>
        </div>
    </div>
    
    <div id="modCats" class="modal">
        <div class="modal-box">
            <h3>Administrar Categor√≠as</h3>
            <div id="catList" style="margin-bottom:15px; max-height:200px; overflow-y:auto;"></div>
            <div style="border-top:1px solid #444; padding-top:10px;">
                <label>Nueva Categor√≠a:</label>
                <div style="display:flex; gap:5px;">
                    <input id="newCatIcon" placeholder="Emoji" style="width:60px; text-align:center;">
                    <input id="newCatName" placeholder="Nombre (Ej: Gimnasio)">
                </div>
                <button class="btn btn-p" onclick="addCat()">Agregar</button>
            </div>
            <button class="btn btn-s" onclick="closeModal('modCats')">Cerrar</button>
        </div>
    </div>

    <div id="modCell" class="modal">
        <div class="modal-box">
            <h3>Detalle Pago</h3>
            <label>Monto (Ej: 100+50)</label>
            <input type="text" id="mcAmt" onchange="calcInput(this)" style="font-size:1.5rem;color:#BB86FC" placeholder="0">
            <label>D√≠a Venc.</label>
            <input type="number" id="mcDay" placeholder="D√≠a (1-31)">
            <label>Pagar con:</label>
            <select id="mcAcc"><option value="">--</option></select>
            <div style="background:#2a2a2a; padding:10px; border-radius:5px; margin:10px 0; border:1px solid #444;">
                <div style="display:flex; align-items:center; gap:10px;">
                    <input type="checkbox" id="mcRepeat" style="width:20px; margin:0;" onchange="document.getElementById('mcRepOpt').style.display = this.checked ? 'block' : 'none'">
                    <label for="mcRepeat" style="margin:0; font-size:0.9rem;">Repetir Vencimiento</label>
                </div>
                <div id="mcRepOpt" style="display:none; margin-top:10px;">
                    <label style="font-size:0.8rem;">Hasta mes:</label>
                    <select id="mcRepMonth"></select>
                </div>
            </div>
            <div style="margin:15px 0; display:flex; gap:10px; align-items:center; background:#333; padding:10px; border-radius:5px;">
                <input type="checkbox" id="mcPaid" style="width:20px; margin:0;">
                <label style="margin:0; cursor:pointer;" for="mcPaid">MARCAR COMO PAGADO</label>
            </div>
            <button class="btn btn-p" onclick="saveCell()">Guardar</button>
            <button class="btn btn-s" onclick="closeModal('modCell')">Cancelar</button>
            <div style="display:flex; gap:5px; margin-top:10px;">
                 <button class="btn-s" style="color:red; border-color:red;" onclick="delCell()">Borrar Mes</button>
                 <button class="btn-s" style="color:#ff5252; border-color:#ff5252; font-size:0.8rem" onclick="delRecursive()">Borrar este y sig.</button>
            </div>
        </div>
    </div>

    <div id="modAcc" class="modal"><div class="modal-box"><h3>Nueva Cuenta</h3><input id="maName" placeholder="Nombre"><input type="text" id="maBal" onchange="calcInput(this)" placeholder="Saldo Inicial (Ej: 5000+200)"><button class="btn btn-p" onclick="saveAcc()">Guardar</button><button class="btn btn-s" onclick="closeModal('modAcc')">Cancelar</button></div></div>

    <div id="modLock" class="modal" style="z-index:9999;">
        <div class="modal-box" style="border:2px solid #ff5252;">
            <h2 style="color:#ff5252">‚ö†Ô∏è Servicio Vencido</h2>
            <p>El periodo de uso ha finalizado.</p>
            <div class="price-display">Valor Actual: <span class="uiPriceDisplay">$...</span></div>
            <p style="font-size:0.8rem; color:#aaa;">C√≥digo DEMO disponible: "DEMO"</p>
            <button class="btn btn-p" onclick="closeModal('modLock'); switchTab('config');">Ir a Pagar</button>
        </div>
    </div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyA79gsaESM8m_9jJY-lYHHHHbIxkGeJ9jA",
      authDomain: "armadopagos.firebaseapp.com",
      projectId: "armadopagos",
      storageBucket: "armadopagos.firebasestorage.app",
      messagingSenderId: "482082107729",
      appId: "1:482082107729:web:e4f29ee165ca1437e76370"
    };

    try { firebase.initializeApp(firebaseConfig); } catch(e) { console.error(e); }
    const auth = firebase.auth();
    const db = firebase.firestore();
    
    const ADMIN_EMAIL = "diegomatteiblanco@gmail.com";
    let currentUser = null;
    let currentGroup = null;
    let appData = { expenses:[], payments:{}, accounts:[], categories:[] };
    let year = 2026;
    let selCell = null;
    let isExpired = false;
    let globalPrice = 0; 
    let activeCategory = 'ALL'; 

    function smartParse(str) { try { if(!str) return 0; let clean = str.toString().replace(/,/g, '.').replace(/[^-()\d/*+.]/g, ''); return eval(clean) || 0; } catch(e) { return 0; } }
    function calcInput(el) { const val = smartParse(el.value); if(val) el.value = val; }
    function stringToColor(str) { if(!str) return 'transparent'; let hash = 0; for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash); const c = (hash & 0x00FFFFFF).toString(16).toUpperCase(); return '#' + "00000".substring(0, 6 - c.length) + c; }
    function getAccName(id) { const acc = appData.accounts.find(a => a.id == id); return acc ? acc.name : ''; }

    db.collection('config').doc('pricing').onSnapshot(doc => { if(doc.exists) { globalPrice = doc.data().val || 0; document.querySelectorAll('.uiPriceDisplay').forEach(el => el.innerText = '$' + parseInt(globalPrice).toLocaleString()); } });

    auth.onAuthStateChanged(user => {
        if(user) {
            currentUser = user;
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('groupScreen').style.display = 'flex';
            document.getElementById('dispUserEmail').innerText = user.email.split('@')[0];
            if(user.email === ADMIN_EMAIL) { document.getElementById('tab-admin').style.display = 'block'; const hoy = new Date(); document.getElementById('adminMonth').value = hoy.getMonth(); }
        } else {
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('groupScreen').style.display = 'none';
            document.querySelector('.app-header').style.display = 'none';
        }
    });

    function togglePass() { const x = document.getElementById("password"); x.type = (x.type === "password") ? "text" : "password"; }
    function loginEmail() { auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value).catch(e => document.getElementById('authMsg').innerText=e.message); }
    function registerEmail() { auth.createUserWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value).catch(e => document.getElementById('authMsg').innerText=e.message); }
    function loginGoogle() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e => document.getElementById('authMsg').innerText=e.message); }
    function resetPass() { const e=document.getElementById('email').value; if(!e) return alert("Ingresa tu correo arriba"); auth.sendPasswordResetEmail(e).then(()=>alert("Revisa tu correo")).catch(e=>alert(e.message)); }
    function logout() { auth.signOut().then(() => location.reload()); }

    function checkGroup() {
        const name = document.getElementById('groupNameInput').value.trim().toUpperCase();
        if(name.length < 3) return document.getElementById('groupMsg').innerText = "Nombre muy corto";
        const pin = document.getElementById('groupPinInput').value.trim();
        db.collection('groups').doc(name).get().then(doc => {
            if(doc.exists) {
                const g = doc.data();
                if(currentUser.email === ADMIN_EMAIL || g.members.includes(currentUser.email)) enterGroup(name, g);
                else {
                    document.getElementById('pinArea').style.display='block';
                    if(pin === g.pin) db.collection('groups').doc(name).update({ members: firebase.firestore.FieldValue.arrayUnion(currentUser.email) }).then(() => enterGroup(name, g));
                    else if(pin) document.getElementById('groupMsg').innerText = "PIN INCORRECTO";
                }
            } else {
                if(confirm("Crear grupo nuevo?")) {
                    const expDate = new Date(); expDate.setDate(expDate.getDate() + 30);
                    const newG = { owner: currentUser.email, members: [currentUser.email], pin: Math.floor(1000+Math.random()*9000).toString(), validUntil: expDate.toISOString() };
                    db.collection('groups').doc(name).set(newG).then(() => enterGroup(name, newG));
                }
            }
        });
    }

    function enterGroup(name, info) {
        currentGroup = name;
        document.getElementById('groupScreen').style.display = 'none';
        document.querySelector('.app-header').style.display = 'flex';
        document.getElementById('headerGroupName').innerText = name;
        db.collection('groups').doc(name).onSnapshot(doc => { if(doc.exists) updateBadge(doc.data().validUntil); });
        updateBadge(info.validUntil);
        document.getElementById('confGName').innerText = name;
        document.getElementById('confPin').innerText = info.pin;
        db.collection('data').doc(name).onSnapshot(doc => {
            if(doc.exists) {
                appData = doc.data();
                if(!appData.expenses) appData.expenses = [];
                if(!appData.payments) appData.payments = {};
                if(!appData.accounts) appData.accounts = [];
                if(!appData.categories || appData.categories.length === 0) {
                    appData.categories = [ {id:'c1',name:'Hogar',icon:'üè†'}, {id:'c2',name:'Oficina',icon:'üè¢'}, {id:'c3',name:'Auto',icon:'üöó'}, {id:'c4',name:'Personal',icon:'üë§'}, {id:'c5',name:'Tarjetas',icon:'üí≥'} ];
                }
            } else saveData();
            renderAll();
        });
    }

    function updateBadge(validUntil) {
        const validDate = new Date(validUntil || 0);
        const now = new Date();
        const diffDays = Math.ceil((validDate - now) / (1000 * 60 * 60 * 24));
        isExpired = diffDays <= 0;
        const tag = document.getElementById('dispGroupTag');
        document.getElementById('confValid').innerText = validDate.toLocaleDateString();
        if(isExpired) {
            tag.innerText = "VENCIDO"; tag.className = "group-tag expired";
            document.getElementById('confValid').innerText = "VENCIDO - PAGO REQUERIDO";
            document.getElementById('confValid').style.color = "#ff5252";
            if(!document.getElementById('modLock').style.display || document.getElementById('modLock').style.display === 'none') setTimeout(() => document.getElementById('modLock').style.display='flex', 1000);
        } else {
            tag.innerText = "GRATIS (" + diffDays + " d√≠as)"; tag.className = "group-tag pro";
            document.getElementById('modLock').style.display='none';
        }
    }

    function renderFilters() {
        const container = document.getElementById('filterList');
        let html = '';
        appData.categories.forEach(c => {
            const activeClass = activeCategory === c.name ? 'active' : '';
            html += `<div class="filter-pill ${activeClass}" onclick="setFilter('${c.name}')">${c.icon} ${c.name}</div>`;
        });
        container.innerHTML = html;
        const allBtn = document.getElementById('filt-ALL');
        if(activeCategory === 'ALL') allBtn.classList.add('active'); else allBtn.classList.remove('active');
    }

    function setFilter(catName) { activeCategory = catName; renderFilters(); renderGrid(); }

    function openModalCats() {
        if(checkLock()) return;
        const list = document.getElementById('catList');
        list.innerHTML = '';
        appData.categories.forEach(c => {
            list.innerHTML += `<div class="cat-item"><span>${c.icon} ${c.name}</span> <button class="btn-s" style="width:auto; color:#ff5252; border-color:#ff5252; font-size:0.7rem;" onclick="delCat('${c.id}')">Eliminar</button></div>`;
        });
        document.getElementById('newCatIcon').value = '';
        document.getElementById('newCatName').value = '';
        document.getElementById('modCats').style.display = 'flex';
    }

    function addCat() {
        const icon = document.getElementById('newCatIcon').value || 'üè∑Ô∏è';
        const name = document.getElementById('newCatName').value;
        if(name) { appData.categories.push({ id: Date.now().toString(), name, icon }); saveData(); openModalCats(); renderFilters(); }
    }

    function delCat(id) { if(confirm("¬øEliminar categor√≠a?")) { appData.categories = appData.categories.filter(c => c.id !== id); saveData(); openModalCats(); renderFilters(); } }

    // --- ZEN MODE ---
    function toggleZen() {
        document.body.classList.toggle('zen-mode');
    }

    // --- COLUMN WIDTH ---
    function setColWidth(w) {
        document.documentElement.style.setProperty('--col-w', w + 'px');
    }

    // --- MONETIZACION Y ADMIN ---
    function generateDynamicHash(g, m, y) { let h=0; const s=g+"_"+m+"_"+y+"_CYM_SECURE_2026"; for(let i=0;i<s.length;i++) h=((h<<5)-h)+s.charCodeAt(i)|0; return Math.abs(h).toString(36).toUpperCase().substring(0,6); }
    function unlockPro() {
        const code = document.getElementById('unlockCode').value.trim().toUpperCase();
        if(code === "DEMO") { extendValidity(new Date(new Date().setMonth(new Date().getMonth() + 1))); return; }
        const now = new Date();
        let foundMatch = false;
        for(let i=0; i<12; i++) {
            const checkDate = new Date(now.getFullYear(), now.getMonth() + i, 1);
            if(code === generateDynamicHash(currentGroup, checkDate.getMonth(), checkDate.getFullYear())) {
                extendValidity(new Date(checkDate.getFullYear(), checkDate.getMonth() + 1, 0));
                foundMatch = true;
                break;
            }
        }
        if(!foundMatch) alert("C√≥digo inv√°lido.");
    }
    function extendValidity(d) { db.collection('groups').doc(currentGroup).update({ validUntil: d.toISOString() }).then(() => { alert("¬°Pago exitoso!"); location.reload(); }); }
    
    function savePrice() { if(currentUser.email!==ADMIN_EMAIL) return; const val=document.getElementById('adminPriceInput').value; if(val) db.collection('config').doc('pricing').set({val:parseInt(val)}).then(()=>alert("Guardado")); }
    function renderAdmin() {
        if(currentUser.email!==ADMIN_EMAIL) return;
        const selY=document.getElementById('adminYear');
        if(selY.options.length<2) { selY.innerHTML=""; const cy=new Date().getFullYear(); for(let i=0;i<=5;i++) { const o=document.createElement('option'); o.value=cy+i; o.text=cy+i; selY.add(o); } }
        document.getElementById('adminPriceInput').value=globalPrice;
        const selM=document.getElementById('adminMonth').value; const currentY=selY.value;
        const listDiv=document.getElementById('adminList'); listDiv.innerHTML='<p style="text-align:center">Cargando...</p>';
        let s={u:0,g:0,a:0,e:0};
        db.collection('groups').get().then(snap=>{
            let h='<table class="admin-table"><thead><tr><th>Grupo</th><th>Vence</th><th>Clave</th></tr></thead><tbody>';
            snap.forEach(doc=>{
                const g=doc.data(); const v=new Date(g.validUntil||0); const exp=v<new Date();
                s.g++; s.u+=(g.members?g.members.length:0); if(exp)s.e++; else s.a++;
                const c=generateDynamicHash(doc.id,parseInt(selM),parseInt(currentY));
                let mHtml=g.members.map(m=>`<div>${m===g.owner?'‚òÖ':''} ${m} ${m!==g.owner?`<span class="del-user" onclick="kickUser('${doc.id}','${m}')">[x]</span>`:''}</div>`).join('');
                mHtml+=`<div class="add-user" onclick="addUser('${doc.id}')">+ Usr</div>`;
                h+=`<tr><td><strong style="color:#fff">${doc.id}</strong><br><div style="font-size:0.7rem;margin-top:5px">${mHtml}</div></td><td><span class="tag-adm" onclick="modDate('${doc.id}','${g.validUntil}')" style="background:${exp?'#ff5252':'#00e676'};color:#000">${v.toLocaleDateString()} ‚úèÔ∏è</span><div style="margin-top:5px"><button class="btn-s" style="padding:2px 5px;font-size:0.7rem;color:#ff5252;border-color:#ff5252" onclick="deleteGroup('${doc.id}')">üóëÔ∏è</button></div></td><td><button class="btn-s" style="padding:10px;color:#BB86FC;border:1px solid #BB86FC" onclick="prompt('Copia:','${c}')">üîë ${c}</button></td></tr>`;
            });
            h+='</tbody></table>'; listDiv.innerHTML=h;
            document.getElementById('statUsers').innerText=s.u; document.getElementById('statGroups').innerText=s.g;
            document.getElementById('statActive').innerText=s.a; document.getElementById('statExpired').innerText=s.e;
        });
    }
    function modDate(id,c){if(currentUser.email!==ADMIN_EMAIL)return;const n=prompt("Fecha YYYY-MM-DD:",c?c.split('T')[0]:'');if(n){const d=new Date(n);if(!isNaN(d.getTime()))db.collection('groups').doc(id).update({validUntil:d.toISOString()});}}
    function kickUser(id,e){if(currentUser.email!==ADMIN_EMAIL)return;if(confirm("¬øSacar usuario?"))db.collection('groups').doc(id).update({members:firebase.firestore.FieldValue.arrayRemove(e)}).then(()=>renderAdmin());}
    function addUser(id){if(currentUser.email!==ADMIN_EMAIL)return;const e=prompt("Email:");if(e&&e.includes('@'))db.collection('groups').doc(id).update({members:firebase.firestore.FieldValue.arrayUnion(e.trim().toLowerCase())}).then(()=>renderAdmin());}
    function deleteGroup(id){if(confirm("¬øBorrar grupo?"))db.collection('groups').doc(id).delete();db.collection('data').doc(id).delete().then(()=>renderAdmin());}

    function restoreBackup(i){if(isExpired)return alert("Vencido");const f=i.files[0];if(!f)return;const r=new FileReader();r.onload=e=>{try{const d=JSON.parse(e.target.result);let nx=[],np={},na=[],nc=[];if(Array.isArray(d.expenses))nx=d.expenses;if(d.payments)np=d.payments;if(Array.isArray(d.accounts))na=d.accounts;if(Array.isArray(d.categories))nc=d.categories;if(confirm("Importar?")){appData={expenses:nx,payments:np,accounts:na,categories:nc.length?nc:appData.categories};saveData();alert("Listo");}}catch(z){alert("Error");}};r.readAsText(f);}
    function downloadBackup(){const b=new Blob([JSON.stringify({...appData,meta:{group:currentGroup,date:new Date()}})],{type:"application/json"});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=`Backup_${currentGroup}.json`;a.click();}
    function saveData(){if(currentGroup)db.collection('data').doc(currentGroup).set(appData);}
    function nukeExpenses(){if(checkLock())return;if(confirm("¬øBorrar TODO?")){appData.expenses=[];appData.payments={};saveData();alert("Borrado");}}
    function nukeAccounts(){if(checkLock())return;if(confirm("¬øBorrar Cuentas?")){appData.accounts=[];saveData();alert("Borrado");}}

    function renderAll(){ renderFilters(); renderGrid(); renderAcc(); calcDash(); }
    
    function renderGrid() {
        const t = document.getElementById('mainTable');
        t.innerHTML = `<thead><tr><th class="col-fix" onclick="sortByMonth(-1)">Concepto (Ordenar)</th>${[...Array(12)].map((_,i)=>`<th onclick="sortByMonth(${i})">${new Date(year,i,1).toLocaleDateString('es-ES',{month:'short'}).toUpperCase()}</th>`).join('')}</tr></thead>`;
        let body = '<tbody>';
        
        const list = activeCategory === 'ALL' ? appData.expenses : appData.expenses.filter(e => e.cat === activeCategory);
        let monthTotals = new Array(12).fill(0);

        list.forEach(e => {
            body += `<tr><td class="col-fix"><span class="expense-name">${e.name}</span><div style="font-size:0.7rem;color:#aaa">${e.cat}</div><div style="margin-top:2px;">${e.folder?`<span class="icon-btn" onclick="window.open('${e.folder}')">üìÅ</span>`:''}${e.link?`<span class="icon-btn" onclick="window.open('${e.link}')">üîó</span>`:''}${e.user||e.pass?`<span class="icon-btn" onclick="alert('U: ${e.user}\\nP: ${e.pass}')">üîë</span>`:''}${e.comment?`<span class="icon-btn" onclick="alert('${e.comment}')">üí¨</span>`:''}<span class="icon-btn" onclick="editExp(${e.id})">‚úèÔ∏è</span></div></td>`;
            for(let i=0; i<12; i++) {
                const k = `${e.id}_${year}_${i}`; const p = appData.payments[k] || {};
                
                if(p.amt || p.paid) {
                    if(p.amt) monthTotals[i] += parseFloat(p.amt);
                }

                let st = '';
                if(p.paid) st = 'status-paid';
                else if(p.amt || p.day) {
                    const today = new Date(); today.setHours(0,0,0,0);
                    const d = p.day ? parseInt(p.day) : 0; 
                    const dl = d > 0 ? new Date(year, i, d) : new Date(year, i + 1, 0);
                    if(dl < today) st = 'status-pend'; else st = 'status-soon';
                }

                const day = (p.day!==undefined && p.day!=='') ? p.day : '';
                const amt = p.amt ? '$'+parseInt(p.amt).toLocaleString() : '';
                const an = p.accId ? getAccName(p.accId) : '';
                const ac = p.accId ? stringToColor(an) : 'transparent';
                
                body += `<td class="${st}" style="padding:0; position:relative;">
                    <div onclick="openCell(${e.id},${i})" class="cell-container">
                        <div class="cell-day">${day}</div>
                        <div class="cell-data"><span class="cell-amt">${amt}</span>${p.accId ? `<div class="acc-dot" style="background:${ac}" title="${an}"></div>` : ''}</div>
                    </div>
                </td>`;
            }
            body += '</tr>';
        });

        let totalRowHTML = `<tr class="row-total"><td class="col-fix">TOTAL A PAGAR</td>`;
        monthTotals.forEach(val => { totalRowHTML += `<td>$${parseInt(val).toLocaleString()}</td>`; });
        totalRowHTML += '</tr>';

        t.innerHTML += body + totalRowHTML + '</tbody>';
    }

    function sortByMonth(mi){
        if(mi===-1) appData.expenses.sort((a,b)=>a.name.localeCompare(b.name));
        else appData.expenses.sort((a,b)=>{
            const pA=appData.payments[`${a.id}_${year}_${mi}`]||{}; const pB=appData.payments[`${b.id}_${year}_${mi}`]||{};
            const dA=(pA.day!==undefined&&pA.day!=='')?parseInt(pA.day):999; const dB=(pB.day!==undefined&&pB.day!=='')?parseInt(pB.day):999;
            if(dA===dB)return a.name.localeCompare(b.name); return dA-dB;
        });
        renderGrid();
    }

    function renderAcc(){
        const l=document.getElementById('accList'); l.innerHTML='';
        const s=document.getElementById('mcAcc'); s.innerHTML='<option value="">--</option>';
        const now=new Date();
        appData.accounts.forEach(a=>{
            let h=''; let tot=0;
            appData.expenses.forEach(e=>{ const k=`${e.id}_${now.getFullYear()}_${now.getMonth()}`; const p=appData.payments[k]; if(p&&p.accId==a.id&&!p.paid&&p.amt){ tot+=parseFloat(p.amt); h+=`<div class="det-row"><span>${e.name}</span><span style="color:#ff5252">-$${parseInt(p.amt).toLocaleString()}</span></div>`; } });
            const proj=(parseFloat(a.bal)||0)-tot; s.innerHTML+=`<option value="${a.id}">${a.name}</option>`;
            l.innerHTML+=`<div class="acc-card"><div class="acc-head" onclick="toggleAcc(${a.id})"><div><b>${a.name}</b><br><span style="font-size:0.8rem;color:#BB86FC">Proyectado: $${proj.toLocaleString()}</span></div><div style="text-align:right"><div style="color:#00e676;font-weight:bold;font-size:1.1rem">$${parseFloat(a.bal).toLocaleString()}</div><div style="margin-top:5px"><span class="icon-btn" onclick="editAcc(${a.id});event.stopPropagation()">‚úèÔ∏è</span> <span class="icon-btn" style="color:red" onclick="delAcc(${a.id});event.stopPropagation()">‚úñ</span></div></div></div><div id="accDet-${a.id}" class="acc-detail"><div class="det-row"><span>Saldo Real</span><span style="color:#fff">$${parseFloat(a.bal).toLocaleString()}</span></div>${h||'<div style="text-align:center;color:#555;font-style:italic;padding:5px">Sin gastos asignados</div>'}<div class="det-total"><div style="display:flex;justify-content:space-between"><span>FINAL PROYECTADO</span><span>$${proj.toLocaleString()}</span></div></div></div></div>`;
        });
    }
    function toggleAcc(id){document.getElementById(`accDet-${id}`).classList.toggle('open');}
    function calcDash(){ let d=0,a=0; const now=new Date(); appData.expenses.forEach(e=>{ const k=`${e.id}_${now.getFullYear()}_${now.getMonth()}`; const p=appData.payments[k]; if(p&&p.amt&&!p.paid) d+=parseInt(p.amt); }); appData.accounts.forEach(ac=>a+=parseFloat(ac.bal)); document.getElementById('dTotal').innerText='$'+a.toLocaleString(); document.getElementById('dDebt').innerText='$'+d.toLocaleString(); document.getElementById('dNet').innerText='$'+(a-d).toLocaleString(); }

    // --- CRUD ---
    let edId=null;
    function openModalExp() {
        if(checkLock()) return; edId=null;
        ['meName','meFolder','meLink','meUser','mePass','meComm'].forEach(i=>document.getElementById(i).value='');
        const catSel = document.getElementById('meCat'); catSel.innerHTML = '';
        appData.categories.forEach(c => { const opt = document.createElement('option'); opt.value = c.name; opt.innerText = c.icon + ' ' + c.name; catSel.add(opt); });
        document.getElementById('modExp').style.display='flex';
    }
    function editExp(id) {
        if(checkLock()) return; edId=id; const e=appData.expenses.find(x=>x.id==id);
        openModalExp(); edId=id;
        document.getElementById('meName').value=e.name; document.getElementById('meFolder').value=e.folder||''; document.getElementById('meLink').value=e.link||''; document.getElementById('meUser').value=e.user||''; document.getElementById('mePass').value=e.pass||''; document.getElementById('meComm').value=e.comment||''; document.getElementById('meCat').value=e.cat;
    }
    function saveExp() {
        const obj={name:val('meName'), cat:val('meCat'), folder:val('meFolder'), link:val('meLink'), user:val('meUser'), pass:val('mePass'), comment:val('meComm')};
        if(edId){ const idx=appData.expenses.findIndex(x=>x.id==edId); appData.expenses[idx]={...appData.expenses[idx], ...obj}; } else appData.expenses.push({id:Date.now(), ...obj});
        saveData(); closeModal('modExp');
    }
    function delExp(){ if(checkLock())return; if(!edId)return; if(confirm("¬øBorrar gasto y pagos?")){appData.expenses=appData.expenses.filter(x=>x.id!==edId); Object.keys(appData.payments).forEach(k=>{if(k.startsWith(edId+"_"))delete appData.payments[k]}); saveData(); closeModal('modExp');} }

    let acId=null;
    function openModalAcc(){ if(checkLock())return; acId=null; document.getElementById('maName').value=''; document.getElementById('maBal').value=''; document.getElementById('modAcc').style.display='flex'; }
    function editAcc(id){ if(checkLock())return; acId=id; const a=appData.accounts.find(x=>x.id==id); document.getElementById('maName').value=a.name; document.getElementById('maBal').value=a.bal; document.getElementById('modAcc').style.display='flex'; }
    function saveAcc(){ const n=val('maName'); const b=smartParse(val('maBal')); if(acId){ const a=appData.accounts.find(x=>x.id==acId); a.name=n; a.bal=b; } else appData.accounts.push({id:Date.now(), name:n, bal:b}); saveData(); closeModal('modAcc'); }
    function delAcc(id){ if(checkLock())return; if(confirm("¬øBorrar?")){appData.accounts=appData.accounts.filter(a=>a.id!=id); saveData();} }

    function openCell(eid, m) {
        if(checkLock()) return; selCell = {eid, m}; const k = `${eid}_${year}_${m}`; const p = appData.payments[k] || {};
        document.getElementById('mcAmt').value = p.amt||''; document.getElementById('mcDay').value = p.day||''; document.getElementById('mcAcc').value = p.accId||''; document.getElementById('mcPaid').checked = p.paid||false;
        document.getElementById('mcRepeat').checked = false; document.getElementById('mcRepOpt').style.display = 'none';
        const sel = document.getElementById('mcRepMonth'); sel.innerHTML = '';
        const months = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
        for(let i=m+1; i<12; i++) { const opt = document.createElement('option'); opt.value = i; opt.text = months[i]; sel.add(opt); }
        document.getElementById('modCell').style.display='flex';
    }
    function saveCell() {
        const k=`${selCell.eid}_${year}_${selCell.m}`; const amt=smartParse(val('mcAmt')); const day=val('mcDay'); const paid=document.getElementById('mcPaid').checked;
        if(amt||day||paid) appData.payments[k]={amt,day,accId:val('mcAcc'),paid}; else delete appData.payments[k];
        if(document.getElementById('mcRepeat').checked && day) { const tm=parseInt(document.getElementById('mcRepMonth').value); for(let i=selCell.m+1;i<=tm;i++){ const nk=`${selCell.eid}_${year}_${i}`; if(!appData.payments[nk])appData.payments[nk]={}; appData.payments[nk].day=day; } }
        saveData(); closeModal('modCell');
    }
    function delCell(){ delete appData.payments[`${selCell.eid}_${year}_${selCell.m}`]; saveData(); closeModal('modCell'); }
    function delRecursive(){ if(confirm("¬øBorrar este y siguientes?")){ for(let i=selCell.m; i<12; i++) delete appData.payments[`${selCell.eid}_${year}_${i}`]; saveData(); closeModal('modCell'); } }

    function checkLock(){ if(isExpired){ document.getElementById('modLock').style.display='flex'; return true; } return false; }
    function val(id){ return document.getElementById(id).value; }
    function switchTab(t){ 
        document.querySelectorAll('.view').forEach(v=>v.classList.remove('active')); document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        if(t==='admin'){document.getElementById('view-admin').classList.add('active'); renderAdmin();} else document.getElementById('view-'+t).classList.add('active');
        const tabEl=document.querySelector(`.tab[onclick="switchTab('${t}')"]`); if(tabEl) tabEl.classList.add('active');
        if(t==='planilla') renderAll();
    }
    function changeYear(d){ year+=d; document.getElementById('dispYear').innerText=year; renderAll(); }
    function closeModal(id){ document.getElementById(id).style.display='none'; }
    function exportExcel(){ const ws=XLSX.utils.table_to_sheet(document.getElementById('mainTable')); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Pagos"); XLSX.writeFile(wb,"Pagos.xlsx"); }

    // FAB DRAG LOGIC
    const fab = document.getElementById('fabBtn');
    let isDragging = false;
    let hasMoved = false;
    let offsetX, offsetY;

    const startDrag = (e) => {
        hasMoved = false;
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        const rect = fab.getBoundingClientRect();
        offsetX = clientX - rect.left;
        offsetY = clientY - rect.top;
        isDragging = true;
    };

    const doDrag = (e) => {
        if (!isDragging) return;
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        hasMoved = true;
        e.preventDefault(); 
        let newX = clientX - offsetX;
        let newY = clientY - offsetY;
        const maxW = window.innerWidth - fab.offsetWidth;
        const maxH = window.innerHeight - fab.offsetHeight;
        newX = Math.max(0, Math.min(newX, maxW));
        newY = Math.max(0, Math.min(newY, maxH));
        fab.style.left = newX + 'px';
        fab.style.top = newY + 'px';
        fab.style.right = 'auto'; 
        fab.style.bottom = 'auto';
    };

    const endDrag = () => { isDragging = false; };

    fab.addEventListener('click', (e) => {
        if (hasMoved) { e.preventDefault(); e.stopPropagation(); } else { openModalExp(); }
    });

    fab.addEventListener('mousedown', startDrag);
    document.addEventListener('mousemove', doDrag);
    document.addEventListener('mouseup', endDrag);
    
    fab.addEventListener('touchstart', startDrag);
    fab.addEventListener('touchmove', doDrag);
    fab.addEventListener('touchend', endDrag);
</script>
</body>
</html>